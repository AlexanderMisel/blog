<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
<title>ngx.re-vs-lpeg</title><link href="../css/han.css" rel="stylesheet">
</head>
<body class='typora-export os-windows' >
<div  id='write'  class = 'is-node'><h1><a name="ngxre与lpeg的性能对比" class="md-header-anchor"></a><span>ngx.re与lpeg的性能对比</span></h1><p><span>上一周清明假期，我开始用luapower自带的nginx搞些事情。Luapower是一个非常棒的LuaJIT二进制发行版，它自带了较为完整的跨平台LuaJIT生态，对于厌恶从C编译的Lua小白（就像我这样的）来说简直是福音啊。它里面就自带了一个nginx，并且支持OpenResty的生态，这就方便了我接下来做的一个有关模式匹配引擎性能的对比。</span></p><p><span>我目前看到的OpenResty相关的模式匹配性能测评基本上都是围绕</span><code>ngx.re</code><span>（即PCRE）与lua pattern的对比。首先大家应该明白一个概念，OpenResty使用的是LuaJIT，它的lua pattern自然也是JIT加成的，所以你的ngx.re也应该开JIT参数跟它比。而开了JIT的</span><code>ngx.re</code><span>是比lua pattern稍快的。由于下面我们要比较的lpeg并非JIT版本，所以跟不加</span><code>jo</code><span>参数的</span><code>ngx.re</code><span>比较也是有意义的。</span></p><p><span>那么JIT是什么呢？我想有人不是那么了解。我为大家翻译了维基百科：</span></p><blockquote><p><span>在</span><a href='https://zh.wikipedia.org/wiki/计算_(计算机科学)'><span>计算机技术</span></a><span>中，</span><strong><span>即时编译</span></strong><span>（</span><strong><span>JIT</span></strong><span>，也称为</span><strong><span>动态翻译</span></strong><span>或</span><strong><span>运行时编译</span></strong><span>）是一种执行</span><a href='https://zh.wikipedia.org/wiki/计算机代码'><span>计算机代码</span></a><span>的方法，这种方法涉及在程序执行过程中（在</span><a href='https://zh.wikipedia.org/wiki/執行期'><span>运行时</span></a><span>）而不是在执行之前进行</span><a href='https://zh.wikipedia.org/wiki/編譯器'><span>编译</span></a><span>。通常，这包括</span><a href='https://zh.wikipedia.org/wiki/源代码'><span>源代码</span></a><span>或更常见的</span><a href='https://zh.wikipedia.org/wiki/字节码'><span>字节码</span></a><span>到</span><a href='https://zh.wikipedia.org/wiki/机器语言'><span>机器码</span></a><span>的转换，然后直接执行。实现JIT编译器的系统通常会不断地分析正在执行的代码，并确定代码的某些部分，在这些部分中，编译或重新编译所获得的加速将超过编译该代码的开销。</span></p></blockquote><p><span>我对lpeg寄予厚望，所以自然要测一下lpeg和ngx.re比起来到底性能怎样。这里使用的数据集来自</span><a href='https://github.com/rust-leipzig/regex-performance'><span>regex-performance</span></a><span>里面的3200.txt文件。不过，我发现如果不加任何优化，在匹配大文件的时候，lpeg会吃亏，所以在搜索的pattern里，我加了最简单的排除法：</span></p><p><span>比如下面第三个例子，我最初的lpeg代码是</span></p><pre lang="" class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">s &lt;- {('Huck' / 'Saw') [a-zA-Z]+} / . s</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 25px;"></div><div class="CodeMirror-gutters" style="display: none; height: 25px;"></div></div></div></pre><p><span>这样的想法是很直接，但会造成搜索的时候，每次向后移一个字符就要再重新匹配一次s，但如果排除掉不是H和S开头的单词的话，那就减少了很多的检查。修改之后是</span></p><pre lang="" class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">s &lt;- {('Huck' / 'Saw') [a-zA-Z]+} / . [^HS]* s</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 25px;"></div><div class="CodeMirror-gutters" style="display: none; height: 25px;"></div></div></div></pre><h2><a name="pattern代码" class="md-header-anchor"></a><span>pattern代码</span></h2><figure><table><thead><tr><th>&nbsp;</th><th><span>ngx.re</span></th><th><span>lpeg</span></th></tr></thead><tbody><tr><td><span>1</span></td><td><code>Twain</code></td><td><code>s &lt;- {&#39;Twain&#39;} / . s</code></td></tr><tr><td><span>2</span></td><td><code>[a-z]shing</code></td><td><code>s &lt;- {[a-z] &#39;shing&#39;} / . s</code></td></tr><tr><td><span>3</span></td><td><code>Huck[a-zA-Z]+|Saw[a-zA-Z]+</code></td><td><code>s &lt;- {(&#39;Huck&#39; / &#39;Saw&#39;) [a-zA-Z]+} / . [^HS]* s</code></td></tr><tr><td><span>4</span></td><td><code>\b\w+nn\b</code></td><td><code>s &lt;- {(!&#39;nn&#39; %w)+ &#39;nn&#39;} %W / . %w* %W* s</code></td></tr><tr><td><span>5</span></td><td><code>[a-q][^u-z]{13}x</code></td><td><code>s &lt;- {[a-q] [^u-z]^13 &#39;x&#39;} / . s</code></td></tr><tr><td><span>6</span></td><td><code>Tom|Sawyer|Huckleberry|Finn</code></td><td><code>s &lt;- {(&#39;Tom&#39; / &#39;Sawyer&#39; / &#39;Huckleberry&#39; / &#39;Finn&#39;)} / . s</code></td></tr><tr><td><span>7</span></td><td><code>.{2,4}(Tom|Sawyer|Huckleberry|Finn)</code></td><td><code>s &lt;- {.^2 .^-2 (&#39;Tom&#39; / &#39;Sawyer&#39; / &#39;Huckleberry&#39; / &#39;Finn&#39;)} / . s</code></td></tr><tr><td><span>8</span></td><td><code>Tom.{10,25}river|river.{10,25}Tom</code></td><td><code>s &lt;- {&#39;Tom&#39; .^10 t1} / {&#39;river&#39; .^10 t2} / .^15 [^Tr]* s</code><br><code>t1 &lt;- (!&#39;river&#39; .)^-15 &#39;river&#39;</code><br><code>t2 &lt;- (!&#39;Tom&#39; .)^-15 &#39;Tom&#39;</code></td></tr><tr><td><span>9</span></td><td><code>[a-z]+ing</code></td><td><code>s &lt;- { t } / . s</code><br><code>t &lt;- [a-zA-Z] (!&#39;ing&#39; [a-zA-Z])* &#39;ing&#39;</code></td></tr><tr><td><span>10</span></td><td><code>\s[a-zA-Z]{0,12}ing\s</code></td><td><code>s &lt;- { %s t %s } / . s</code><br><code>t &lt;- (!&#39;ing&#39; [a-zA-Z])^-12 &#39;ing&#39;</code></td></tr><tr><td><span>11</span></td><td><code>[&quot;&#39;][^&quot;&#39;]{0,30}[?!.][&quot;&#39;]</code></td><td><code>s &lt;- {[&quot;&#39;][^&quot;&#39;] (!t .)^-30 t} / . [^&quot;&#39;]* s</code><br><code>t &lt;- [?!.][&quot;&#39;]</code></td></tr><tr><td><span>12</span></td><td><code>\u{221E}|\u{2713}</code></td><td><code>s &lt;- {&#39;\u{221E}&#39; / &#39;\u{2713}&#39;} / . [^\226]* s</code></td></tr></tbody></table></figure><h2><a name="nginx配置" class="md-header-anchor"></a><span>nginx配置</span></h2><p><span>我使用了最基础的nginx配置（因为我是nginx的新手）。不过做这个测试应该已经足够了。</span><code>error_log</code><span>我设置成了info等级，方便我调试代码（因为</span><code>print</code><span>函数默认会打info等级的日志，我还不太常用</span><code>ngx.log</code><span>）</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="nginx" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="nginx"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">worker_processes</span>  1;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">error_log</span> logs/error.<span class="cm-tag">log info</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">events</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">worker_connections</span> 1024;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">http</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-2">server</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string-2">listen</span> 6699;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-2">location</span> = / {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">charset</span> <span class="cm-number">UTF-8</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">content_by_lua_file test</span>.lua;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 345px;"></div><div class="CodeMirror-gutters" style="display: none; height: 345px;"></div></div></div></pre><h2><a name="测试结果" class="md-header-anchor"></a><span>测试结果</span></h2><p><span>纵坐标单位是秒（越少越好），显示的是上述pattern执行次数是100次的时间。</span></p><p><img src="../img/re-vs-lpeg.png" referrerpolicy="no-referrer"></p><p><span>可以看出我们的lpeg还是很争气的，性能要比没有JIT加成的PCRE好一些。不过，在JIT加成后的PCRE比起来，还是有差距。但我想，如果lpeg也用JIT的方法把它的VM（lpeg本身是先翻译成bytecode，再在VM里执行的）重写一下，性能超过PCRE JIT应该是没有问题的。而且，大家可以发现，lpeg可以进行一些针对性的优化，而正则的话，想要优化可能并不容易。</span><a href='../' title='返回首页'><span>∎</span></a></p></div>
<script src="../dist/mini_pangu.js"></script>
</body>
</html>