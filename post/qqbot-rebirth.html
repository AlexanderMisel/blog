<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
<title>让Q群机器人于Mirai框架中重生</title>
<meta name="keywords" content="Mirai,Mirai-Native,插件,迁移,mirai-console,机器人,QQ" />
<link href="../css/han.css" rel="stylesheet">
</head>
<body class='typora-export'>
<div id='write'  class=''><h1><a name="让q群机器人于mirai框架中重生" class="md-header-anchor"></a><span>让Q群机器人于Mirai框架中重生</span></h1><p><span>在前面另一篇博客《</span><a href='./chores.html#qq群机器人框架迁移'><span>一些杂事</span></a><span>》中我就提到了迁移QQ机器人代码，这次又写这个的原因是，那次的迁移方式与这次很不一样。在那篇博客里面就已经提到，酷Q面临停止服务，以前大量基于酷Q的机器人要么直接停止维护，要么换框架。作为四个维基百科大群的公用群机器人，我们自然是不可能停止维护的，那只能考虑迁移。</span></p><p><span>在软件工程领域，迁移（也就是“移植”）是说将某个可执行的程序，迁移到另一个环境，让它重新运作。</span><sup class='md-footnote'><a href='#dfref-footnote-1' name='ref-footnote-1'>1</a></sup><span> 酷Q是E语言写的，而Mirai是Kotlin（一种JVM语言）编写的。虽然底层不一样，但本质都是QQ协议，没有什么重大的不同。因为我们不对接底层，只对接上层。只要上层一样，那么底层是什么完全不重要。</span></p><p><span>在之前那篇博客中，我们使用的库叫做lua-mirai。那个库很有朝气，不错，我很看好那个库。但因为luaj的一些限制，还是不如原本的lua好用。如果整个bot都迁移过去的话，也少不了重构一些代码。这次呢，我使用的是另一套方案，</span><a href='https://github.com/iTXTech/mirai-native'><span>mirai-native</span></a><span>，这个库的目的就是从根上兼容酷Q的API。Mirai Native需要酷Q插件的DLL和JSON文件，我使用的CoolQ Socket API的维护者mrhso在前面为我们探了路，并且提供了这两个文件，这也是我今天只花了几个小时就迁移成功的重要原因。</span></p><p><span>下面我就具体向大家介绍把酷Q机器人迁移过来的细节。Mirai Native的和众多Mirai系软件一样，文档并不给力。如果按文档安装反而会比较迷茫。曾经有一个好用的工具可以解决这个问题，MiraiOK，但在我用的时候它已经凉凉了，无法下载JDK。不过下载JDK这件事并不难，不需要自动也没什么关系。话休絮烦，继续。</span></p><p><span>Mirai Native只支持</span><strong><span>Windows上的32位JDK</span></strong><span>（JRE），划重点，Mirai Native是作为Mirai Console的一个插件存在的。所以想要运行Mirai Native，你需要以下这么几个库</span></p><ul><li><span>mirai-core-qqandroid</span></li><li><span>mirai-console</span></li><li><span>mirai-console-pure</span></li></ul><p><span>这三个库中，core可以直接用最新的（我用的1.2.3版本），console和console-pure应该要用与Mirai Native匹配的版本，不然有可能不兼容（我用的1.0-M4-dev-3版本）。这三个jar包可以从bintray里面下载，也可以从</span><a href='https://github.com/project-mirai/mirai-repo/tree/master/shadow'><span>shadow</span></a><span>里面下载，希望大家不要找不到了。</span></p><p><span>上面说JRE的时候我还忘记提一点，最新的mirai-console把JDK版本提到了11+，这带来了一个问题，官方版本的JDK的32位版本只有JDK8，再高的版本都不提供32位版本。我为此多方打听，得知有个第三方的JDK可以支持，就是</span><a href='https://adoptopenjdk.net' target='_blank' class='url'>https://adoptopenjdk.net</a><span> 。不过这个JDK在运行Mirai的时候有两个库提示Undefined，分别是jline和jansi。不过缺啥补啥，我马上去maven网站把这两个库的最新版（jline-3.16.0，jansi-1.18）都下载了下来，而且没有遇到版本不兼容的问题。</span></p><p><span>依赖都搞好了之后，我们就该尝试尝试运行了。这一点就是按</span><a href='https://github.com/mamoe/mirai-console/blob/master/docs/Run.md'><span>文档</span></a><span>操作了，先建一个批处理start.bat</span></p><pre lang="bat" class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bat"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><span><span>​</span>x</span></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">@echo</span> <span class="cm-identifier">off</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-identifier">title</span> <span class="cm-identifier">Mirai</span> <span class="cm-identifier">Console</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-identifier">java</span> <span class="cm-operator">-</span><span class="cm-builtin">cp</span> <span class="cm-string">"./libs/*"</span> <span class="cm-identifier">net</span><span class="cm-punctuation">.</span><span class="cm-identifier">mamoe</span><span class="cm-punctuation">.</span><span class="cm-identifier">mirai</span><span class="cm-punctuation">.</span><span class="cm-identifier">console</span><span class="cm-punctuation">.</span><span class="cm-identifier">pure</span><span class="cm-punctuation">.</span><span class="cm-identifier">MiraiConsolePureLoader</span> <span class="cm-operator">%*</span></span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">pause</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 88px;"></div><div class="CodeMirror-gutters" style="display: none; height: 88px;"></div></div></div></pre><p><span>执行这个批处理，就可以打开Mirai Console的控制台版本了。跑起来了还没完，这只是一个裸机器人，要加上我们的酷Q插件，并且跑起来我们原来的bot才大功告成。Mirai的文件结构是下面这样子的，</span></p><pre lang="" class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">├─config</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│  ├─Console</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│  └─ConsoleBuiltIns</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">├─data</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│  ├─image</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│  ├─MiraiNative</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│  │  ├─data</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│  │  ├─libraries</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│  │  └─plugins</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">│  └─record</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">├─libs</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">├─logs</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">└─plugins</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 286px;"></div><div class="CodeMirror-gutters" style="display: none; height: 286px;"></div></div></div></pre><p><span>刚才我们提到的5个基础Java库我都放在了libs下面，而mirai-native这个jar包位于最外层的plugins目录。而我们的酷Q插件的DLL和JSON需要放在data/MiraiNative/plugins里面。如果我们的DLL还依赖其他DLL，那就放在libraries里面。</span></p><p><span>以上都弄好之后，我们就可以登录了，登录也是一个命令</span></p><pre lang="" class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">login id password</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>登录之后会自动加载所有的插件。如果想要知道还有什么命令的话，就</span><code>help</code><span>一下就好了。Mirai本身虽然还有一些问题，但它还在快速的迭代之中，相信它会变得越来越稳定可靠。我当初使用酷Q的一个重要原因也是稳定。</span><a href='../' title='返回首页'><span>∎</span></a></p><div class='footnotes-area'  ><hr/>
<div class='footnote-line'><span class='md-fn-count'>1</span> <span>参考维基百科</span><a href='https://zh.wikipedia.org/wiki/%E7%A7%BB%E6%A4%8D_(%E8%BB%9F%E9%AB%94)'><span>移植</span></a><span>条目。</span> <a name='dfref-footnote-1' href='#ref-footnote-1' title='回到文档' class='reversefootnote' >↩</a></div></div></div>
<script src="../dist/style_fix.js"></script>
<script src="../dist/mini_pangu.js"></script>
</body>
</html>