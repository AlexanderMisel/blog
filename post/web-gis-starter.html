<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
<title>web-gis-starter</title><link href="../css/han.css" rel="stylesheet">
</head>
<body class='typora-export'>
<div id='write'  class=''><h1><a name="web-gis零基础入门" class="md-header-anchor"></a><span>Web GIS零基础入门</span></h1><p><span>我基本上可以说是Web GIS零基础了。最近两个星期左右的时间，我努力学习这方面知识，终于有点点入门了。另外，最近我为公司设计图上呈现服务，主要就是关于Web GIS的，所以我也不得不恶补了两个星期的GIS相关的知识。在我学习的过程中，我也不断修改设计，而且也完善了一系列与这有关的维基百科条目。本文我主要想避开公司业务，谈一谈能够分享给大家的我这两周学到的东西。首先还是先给大家看看Web GIS的维基介绍。</span></p><blockquote><p><strong><span>网络地图服务</span></strong><span>是指使用网络上的地理信息系统（GIS）提供的地图的过程。</span><strong><span>网络地图</span></strong><span>或</span><strong><span>在线地图</span></strong><span>既可以服务也可以消费，因此网络地图不仅仅是网络制图，它是一种消费者可以选择地图将显示什么的服务。Web GIS强调的地理数据处理方面更多的是涉及到数据采集等设计方面和数据存储、算法等服务器软件结构，而不是终端用户报告本身。</span></p></blockquote><p><span>很多人喜欢把Web与GIS连在一起，但其实是错误的用法，应当分开成两个单词。关于Web GIS有很多概念，我不想一股脑地列出来，让我们逐步来揭开Web GIS的面纱。Web GIS相关知识的中文资料亦有不少，我尤其要推荐的就是</span><a href='https://www.osgeo.cn/'><span>OSGeo中国中心</span></a><span>这个网站，它是全中文的，是由国家遥感中心发起、Autodesk中国有限公司协助，经OSGeo正式授权的非营利性组织。这个网站上不光有开源GIS的学习资料，还有开源GIS，如GeoServer、MapServer的中文文档。</span></p><p><span>既然Web GIS服务，那它就一定跟桌面GIS软件有所区别。它们本质上虽然都是GIS，但Web GIS的用户群体更多属于非专业的用户。他们没有专业的地理知识，他们使用Web GIS的主要目的是借助地图获取相关的地理信息。Web地图相对于传统地图的优势在于可交互性。好了不多说废话了，聊点实在的技术吧。</span></p><p><span>要搭建一套Web GIS系统，其实无非就是前端、后端、数据库嘛。把这三者都搞定了，基本上就可以搞定一个简单的GIS系统了。下图就是一个结合 Google 和网页功能的地理信息系统示例架构图。（图片来自维基共享资源，CC BY-SA）</span></p><p><img src="https://upload.wikimedia.org/wikipedia/commons/0/09/GeoServer_GeoNetwork_with_web_app.svg" alt="opengis_architecture" style="max-height: 30em;" /></p><h2><a name="开源地图前端以及与地图服务对接" class="md-header-anchor"></a><span>开源地图前端以及与地图服务对接</span></h2><p><span>常用的开源GIS前端有Leaflet、OpenLayers、Maptalks。其中Maptalks虽然名气不大，但是很好用，这里推荐一下。使用开源GIS前端的好处在于以不变应万变。后端怎么变，我前端实现基本功能做的事情几乎都是相同的：对接瓦片接口，然后大部分开源前端附带的效果就都有了。世界就应该是这样，简单明了。虽然事实上，各个商业GIS后端实现各种各样的接口，还有附带JS API，但我的观点是那些东西能不用就不用。</span></p><p><span>经常有码农抱怨，“别出新技术了，我学不动了”之类。我认为不同厂商在自我陶醉于整自己一套API的时候，不妨想一下，为何不直接扔给对方一套用Leaflet或者Openlayers对接的例子呢？其实对于大多数事面上的使用来说，只对接瓦片就足够了。那些本来用通用前端就能实现的功能，已经不需要服务器端再去折腾半天叠加到图像上了。所以我心目中，GIS的最简单配置就是Leaflet对接上一个瓦片缓存结束。没有那么多乱七八糟的。</span></p><p><span>当然，有些功能必须后端实现。什么功能呢？我认为就是那些涉及到前端没有呈现的数据的地方。比如地理信息的过滤、搜索、路线规划等。前端没有那么多视图区域以外的信息，这些信息是存储在上图中的Datastores里面的，可能需要GIS服务器的再次加工，才可以返回前端使用。</span></p><p><span>既然说到瓦片，那我们就要聊一下瓦片的标准协议了，那就是WMTS，全称叫做Web地图瓦片服务。这个标准出来之前其实缓存瓦片在地图服务里面已经是非常常见的操作了。常见的变体是TMS瓦片协议，它是WMTS的前身，选取的坐标原点和坐标的方向于WMTS不同。在Leaflet中，只要打开tms这个参数，就会按照TMS的规则获取瓦片。另外在XYZ瓦片协议里面，也有z/x/y和z/y/x两种不同的顺序，ArcGIS就是z/y/x的顺序，需要注意一下。一般来说，按照这些，就可以应付市面上90%的地图了。如果倒霉需要对接特别的切图方式的，那实在不行就直接用人家的JS API吧。</span></p><p><span>搞地图还需要稍稍了解一下地图投影的相关知识。但也不用了解太深。首先是基础概念（来自维基百科）</span></p><blockquote><p><span>地图投影，是指按照一定的数学法则将地球椭球面上的经纬网转换到平面上，使地面的地理坐标 </span><span class="MathJax_SVG" tabindex="-1" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.578ex" height="2.774ex" viewBox="0 -835.3 2401.7 1194.5" role="img" focusable="false" style="vertical-align: -0.834ex;"><defs><path stroke-width="0" id="E2-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path stroke-width="0" id="E2-MJMATHI-3D5" d="M409 688Q413 694 421 694H429H442Q448 688 448 686Q448 679 418 563Q411 535 404 504T392 458L388 442Q388 441 397 441T429 435T477 418Q521 397 550 357T579 260T548 151T471 65T374 11T279 -10H275L251 -105Q245 -128 238 -160Q230 -192 227 -198T215 -205H209Q189 -205 189 -198Q189 -193 211 -103L234 -11Q234 -10 226 -10Q221 -10 206 -8T161 6T107 36T62 89T43 171Q43 231 76 284T157 370T254 422T342 441Q347 441 348 445L378 567Q409 686 409 688ZM122 150Q122 116 134 91T167 53T203 35T237 27H244L337 404Q333 404 326 403T297 395T255 379T211 350T170 304Q152 276 137 237Q122 191 122 150ZM500 282Q500 320 484 347T444 385T405 400T381 404H378L332 217L284 29Q284 27 285 27Q293 27 317 33T357 47Q400 66 431 100T475 170T494 234T500 282Z"></path><path stroke-width="0" id="E2-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path><path stroke-width="0" id="E2-MJMATHI-3BB" d="M166 673Q166 685 183 694H202Q292 691 316 644Q322 629 373 486T474 207T524 67Q531 47 537 34T546 15T551 6T555 2T556 -2T550 -11H482Q457 3 450 18T399 152L354 277L340 262Q327 246 293 207T236 141Q211 112 174 69Q123 9 111 -1T83 -12Q47 -12 47 20Q47 37 61 52T199 187Q229 216 266 252T321 306L338 322Q338 323 288 462T234 612Q214 657 183 657Q166 657 166 673Z"></path><path stroke-width="0" id="E2-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="#E2-MJMAIN-28" x="0" y="0"></use><use xlink:href="#E2-MJMATHI-3D5" x="389" y="0"></use><use xlink:href="#E2-MJMAIN-2C" x="985" y="0"></use><use xlink:href="#E2-MJMATHI-3BB" x="1429" y="0"></use><use xlink:href="#E2-MJMAIN-29" x="2012" y="0"></use></g></svg></span><script type="math/tex">(\phi ,\lambda )</script><span> 与平面直角坐标 </span><span class="MathJax_SVG" tabindex="-1" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.323ex" height="2.774ex" viewBox="0 -835.3 2291.7 1194.5" role="img" focusable="false" style="vertical-align: -0.834ex;"><defs><path stroke-width="0" id="E3-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path stroke-width="0" id="E3-MJMATHI-78" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path><path stroke-width="0" id="E3-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path><path stroke-width="0" id="E3-MJMATHI-79" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path stroke-width="0" id="E3-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="#E3-MJMAIN-28" x="0" y="0"></use><use xlink:href="#E3-MJMATHI-78" x="389" y="0"></use><use xlink:href="#E3-MJMAIN-2C" x="961" y="0"></use><use xlink:href="#E3-MJMATHI-79" x="1405" y="0"></use><use xlink:href="#E3-MJMAIN-29" x="1902" y="0"></use></g></svg></span><script type="math/tex">(x,y)</script><span> 建立起函数关系，投影的一般公式为 </span><span class="MathJax_SVG" tabindex="-1" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="14.684ex" height="5.954ex" viewBox="0 -1549.6 6322.2 2563.5" role="img" focusable="false" style="vertical-align: -2.355ex;"><defs><path stroke-width="0" id="E4-MJMAIN-7B" d="M434 -231Q434 -244 428 -250H410Q281 -250 230 -184Q225 -177 222 -172T217 -161T213 -148T211 -133T210 -111T209 -84T209 -47T209 0Q209 21 209 53Q208 142 204 153Q203 154 203 155Q189 191 153 211T82 231Q71 231 68 234T65 250T68 266T82 269Q116 269 152 289T203 345Q208 356 208 377T209 529V579Q209 634 215 656T244 698Q270 724 324 740Q361 748 377 749Q379 749 390 749T408 750H428Q434 744 434 732Q434 719 431 716Q429 713 415 713Q362 710 332 689T296 647Q291 634 291 499V417Q291 370 288 353T271 314Q240 271 184 255L170 250L184 245Q202 239 220 230T262 196T290 137Q291 131 291 1Q291 -134 296 -147Q306 -174 339 -192T415 -213Q429 -213 431 -216Q434 -219 434 -231Z"></path><path stroke-width="0" id="E4-MJMATHI-78" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path><path stroke-width="0" id="E4-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path stroke-width="0" id="E4-MJMATHI-66" d="M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z"></path><path stroke-width="0" id="E4-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path stroke-width="0" id="E4-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path stroke-width="0" id="E4-MJMATHI-3D5" d="M409 688Q413 694 421 694H429H442Q448 688 448 686Q448 679 418 563Q411 535 404 504T392 458L388 442Q388 441 397 441T429 435T477 418Q521 397 550 357T579 260T548 151T471 65T374 11T279 -10H275L251 -105Q245 -128 238 -160Q230 -192 227 -198T215 -205H209Q189 -205 189 -198Q189 -193 211 -103L234 -11Q234 -10 226 -10Q221 -10 206 -8T161 6T107 36T62 89T43 171Q43 231 76 284T157 370T254 422T342 441Q347 441 348 445L378 567Q409 686 409 688ZM122 150Q122 116 134 91T167 53T203 35T237 27H244L337 404Q333 404 326 403T297 395T255 379T211 350T170 304Q152 276 137 237Q122 191 122 150ZM500 282Q500 320 484 347T444 385T405 400T381 404H378L332 217L284 29Q284 27 285 27Q293 27 317 33T357 47Q400 66 431 100T475 170T494 234T500 282Z"></path><path stroke-width="0" id="E4-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path><path stroke-width="0" id="E4-MJMATHI-3BB" d="M166 673Q166 685 183 694H202Q292 691 316 644Q322 629 373 486T474 207T524 67Q531 47 537 34T546 15T551 6T555 2T556 -2T550 -11H482Q457 3 450 18T399 152L354 277L340 262Q327 246 293 207T236 141Q211 112 174 69Q123 9 111 -1T83 -12Q47 -12 47 20Q47 37 61 52T199 187Q229 216 266 252T321 306L338 322Q338 323 288 462T234 612Q214 657 183 657Q166 657 166 673Z"></path><path stroke-width="0" id="E4-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path><path stroke-width="0" id="E4-MJMATHI-79" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path stroke-width="0" id="E4-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path stroke-width="0" id="E4-MJSZ3-7B" d="M618 -943L612 -949H582L568 -943Q472 -903 411 -841T332 -703Q327 -682 327 -653T325 -350Q324 -28 323 -18Q317 24 301 61T264 124T221 171T179 205T147 225T132 234Q130 238 130 250Q130 255 130 258T131 264T132 267T134 269T139 272T144 275Q207 308 256 367Q310 436 323 519Q324 529 325 851Q326 1124 326 1154T332 1205Q369 1358 566 1443L582 1450H612L618 1444V1429Q618 1413 616 1411L608 1406Q599 1402 585 1393T552 1372T515 1343T479 1305T449 1257T429 1200Q425 1180 425 1152T423 851Q422 579 422 549T416 498Q407 459 388 424T346 364T297 318T250 284T214 264T197 254L188 251L205 242Q290 200 345 138T416 3Q421 -18 421 -48T423 -349Q423 -397 423 -472Q424 -677 428 -694Q429 -697 429 -699Q434 -722 443 -743T465 -782T491 -816T519 -845T548 -868T574 -886T595 -899T610 -908L616 -910Q618 -912 618 -928V-943Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="#E4-MJSZ3-7B"></use><g transform="translate(917,0)"><g transform="translate(-13,0)"><g transform="translate(0,600)"><use xlink:href="#E4-MJMATHI-78" x="0" y="0"></use><use xlink:href="#E4-MJMAIN-3D" x="849" y="0"></use><g transform="translate(1905,0)"><use xlink:href="#E4-MJMATHI-66" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#E4-MJMAIN-31" x="692" y="-213"></use></g><use xlink:href="#E4-MJMAIN-28" x="2849" y="0"></use><use xlink:href="#E4-MJMATHI-3D5" x="3238" y="0"></use><use xlink:href="#E4-MJMAIN-2C" x="3834" y="0"></use><use xlink:href="#E4-MJMATHI-3BB" x="4278" y="0"></use><use xlink:href="#E4-MJMAIN-29" x="4861" y="0"></use></g><g transform="translate(0,-650)"><use xlink:href="#E4-MJMATHI-79" x="0" y="0"></use><use xlink:href="#E4-MJMAIN-3D" x="774" y="0"></use><g transform="translate(1830,0)"><use xlink:href="#E4-MJMATHI-66" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#E4-MJMAIN-32" x="692" y="-213"></use></g><use xlink:href="#E4-MJMAIN-28" x="2774" y="0"></use><use xlink:href="#E4-MJMATHI-3D5" x="3163" y="0"></use><use xlink:href="#E4-MJMAIN-2C" x="3759" y="0"></use><use xlink:href="#E4-MJMATHI-3BB" x="4203" y="0"></use><use xlink:href="#E4-MJMAIN-29" x="4786" y="0"></use></g></g></g></g></svg></span><script type="math/tex">\begin{cases}x=f_{1}(\phi ,\lambda )\\y=f_{2}(\phi ,\lambda )\end{cases}</script><span>，这是绘制地图的数学基础之一。</span></p></blockquote><p><span>我们买到的普通的地图，也都是投影的结果。因为地球表面本身是三维的，不能直接在二维平面上绘制，就需要进行投影。Web地图本质上也是地图，当然也要进行投影。常见的地图投影如下：</span></p><figure><table><thead><tr><th><span>ESPG标识码</span></th><th><span>正式名称</span></th><th><span>含义</span></th></tr></thead><tbody><tr><td><span>EPSG:3395</span></td><td><span>WGS 84 / World Mercator</span></td><td><span>真正的墨卡托投影，椭球面形式，拥有保角特性</span></td></tr><tr><td><span>EPSG:3857</span></td><td><span>WGS 84 / Pseudo-Mercator</span></td><td><span>Web墨卡托投影，在线地图常见投影</span></td></tr><tr><td><span>EPSG:4326</span></td><td><span>WGS 84</span></td><td><span>世界大地测量系统1984，在GPS中使用</span></td></tr></tbody></table></figure><p><span>其中，我国首个官方免费地图服务“天地图”中的地图一半用到的就是球面墨卡托（EPSG:3857）和经纬度投影（CGCS2000，厘米级兼容EPSG:4326）。Leaflet理所当然地默认选择Web墨卡托，因为几乎所有在线地图都是这个投影法。但是在对接专网的时候，我发现CGCS2000才是主流。</span></p><p><span>此外，如果你对接互联网上的地图的时候，你还需要关注坐标是不是有偏的问题。我国互联网上的地图几乎都是有偏的。这个原因是“中华人民共和国测绘限制”。他们这些这些地图虽然也用球面墨卡托，但他们用的坐标系是经过混淆算法处理的。GCJ-02（官方称</span><strong><span>地形图非线性保密处理算法</span></strong><span>，俗称</span><strong><span>火星坐标系</span></strong><span>）这种坐标系统在中国非常常用的坐标系。根据经验，这种混淆带来的偏差大概在50m左右。如果大家获取的坐标与地图的坐标系不一样，直接在地图上标点的话，就会出现偏移的现象。即便是使用国外的Google地图，由于Google地图从2006年以来从高德公司获取地图信息，所以依然是有偏的。由于OpenStreetMap是志愿者根据卫星图描出来的，所以没有偏移的现象。</span></p><h3><a name="矢量地图图层" class="md-header-anchor"></a><span>矢量地图图层</span></h3><p><span>有人可能想到了矢量地图图层。矢量图层和栅格图层是地图图层的两大类。它们的对接方法是完全不一样的。在若干年前，矢量图层都是由地图后端预先生成之后返给前端的。不管是ESRI的Shapefile也好，GML也好，都是给服务器端（或者客户端）用的。但随着现在普通个人电脑的硬件升级，浏览器WebGL相关技术的实现，就可以考虑把矢量渲染这项工作下放到浏览器端了。</span></p><p><span>后端生成这种确实可以利用后端的硬件优势，以及直接访问数据的权限，加快矢量图的渲染，但这也降低了前端的扩展性。不说那么多背景。说一下现在矢量地图图层常用的格式。GeoJSON、Mapbox Vector Tile（MVT）这两个是最常见的矢量图层格式。GeoJSON几乎是所有开源前端都支持的一种格式，也是大家几乎都会接触到的一种格式。GeoJSON的表现力有限，但足够现代化，你要知道JSON就是比XML现代化。为什么？因为前端JS可以直接读取JSON啊，你想要给前端用就要用JSON啊。所以我就非常喜欢GeoJSON。但你如果想要完全用矢量数据生成一张地图，那当前开源界似乎只有MVT了。Mapbox GL JS是最成功的一个案例，它不是一个简简单单的呈现库，它附带了多项算法，就是为了优化矢量图层的生成，其中就有著名的“道格拉斯-普克算法”。国内一些小公司做矢量地图几乎无一例外地在开源Mapbox基础上略作修改，就成现成的产品了。当然，这也方便了我们对接，直接拿mapbox的对接库去对接，碰碰运气，说不定就对上了。</span></p><p><span>矢量图层由于是前端动态绘制，有一个天然的优势就是可以自由地处理地图的样式。想让地图一些要素不可见也非常容易。而且不必给后端发请求去动态过滤需要的要素（传统地图实现此功能就需要这样了）。不过Mapbox最近有些让我不爽，因为Mapbox GL JS的协议从BSD-3-Clause切换到了一个不怎么自由的Mapbox Terms of Service。使用它的库还需要注册Mapbox帐号，即便你用根本不是Mapbox的地图，你只不过是用它的JS去接一个符合它规范的地图，比如OpenMapTiles。如果大家想用真正免费的矢量瓦片的话，可以看看</span><a href='https://osmlab.github.io/osm-qa-tiles/'><span>这里</span></a><span>，这是人文主义OSM团队提供的，有区分国家版本。不过提醒你，你下载到中国地图会没有台湾和所有争议地区。这一点如果是正规用途肯定是不行的，个人玩玩还好。</span></p><h2><a name="地图后端" class="md-header-anchor"></a><span>地图后端</span></h2><p><span>事实上我对于地图后端的了解是不够多的。主要是因为大多数情况，大家只要对接互联网上免费的，或者别的公司提供的地图服务就好了，不需要自己搭建地图服务器。</span></p><p><span>但为了完整性，我还是介绍一下我了解到的地图后端的相关知识，给大家参考。以下列举几个成熟的地图服务，</span></p><p><img src="../img/map_server.png" referrerpolicy="no-referrer" alt="map_server"></p><p><span>这是OSGeo上排名前几的地图服务器。最好的两个选择是GeoServer与MapServer。前者优势是Java开发，符合产品线技术栈；后者用C语言实现，比前者快。</span></p><h4><a name="自行构建地图后端的可能性" class="md-header-anchor"></a><span>自行构建地图后端的可能性</span></h4><p><span>由于瓦片服务实现相对容易，这就为我们自行构建地图后端提供了可能性。我尝试用Nginx+Lua访问本地图片构建了一个简单的实现</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="lua"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="lua"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><span><span>​</span>x</span></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span class="cm-variable">level</span> = <span class="cm-builtin">string.format</span>(<span class="cm-string">'L%02d'</span>, <span class="cm-builtin">tonumber</span>(<span class="cm-variable">ngx.var</span>[<span class="cm-number">1</span>]))</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span class="cm-variable">r_str</span> = <span class="cm-builtin">string.format</span>(<span class="cm-string">'R%08X'</span>, <span class="cm-builtin">tonumber</span>(<span class="cm-variable">ngx.var</span>[<span class="cm-number">2</span>]))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span class="cm-variable">c_str</span> = <span class="cm-builtin">string.format</span>(<span class="cm-string">'C%08X'</span>, <span class="cm-builtin">tonumber</span>(<span class="cm-variable">ngx.var</span>[<span class="cm-number">3</span>]))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span class="cm-variable">file</span>, <span class="cm-variable">err</span> = <span class="cm-builtin">io.open</span>(<span class="cm-string">[[/path/to/tile/]]</span> .. <span class="cm-variable">level</span> .. <span class="cm-string">'/'</span> .. <span class="cm-variable">r_str</span> .. <span class="cm-string">'/'</span> .. <span class="cm-variable">c_str</span> .. <span class="cm-string">'.jpg'</span>, <span class="cm-string">'rb'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">if</span> <span class="cm-keyword">not</span> <span class="cm-variable">file</span> <span class="cm-keyword">then</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ngx.log</span>(<span class="cm-variable">ngx.ERR</span>, <span class="cm-string">"open file error:"</span>, <span class="cm-variable">err</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ngx.exit</span>(<span class="cm-variable">ngx.HTTP_SERVICE_UNAVAILABLE</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ngx.say</span>(<span class="cm-variable">file</span>:<span class="cm-builtin">read</span>(<span class="cm-string">'*all'</span>));</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">file</span>:<span class="cm-builtin">close</span>();</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 264px;"></div><div class="CodeMirror-gutters" style="display: none; height: 264px;"></div></div></div></pre><p><span>这个实现旨在独立提供GIS瓦片服务。使用开源前端Leaflet测试过可以正常使用。另外，自行构建的地图天然就支持多种架构，ARM架构也可以轻松部署，而且较为轻便，所以也是可以考虑的一个选项。</span></p><p><span>Web GIS领域还有很多很多知识，我只是开个头，让大家有个初步的认识。如果想要深入了解，还是推荐大家去</span><a href='https://www.osgeo.cn/'><span>OSGeo中国中心</span></a><span>网站看看咯。希望这篇博客对大家有帮助。</span><a href='../' title='返回首页'><span>∎</span></a></p></div>
<script src="../dist/style_fix.js"></script>
<script src="../dist/mini_pangu.js"></script>
</body>
</html>
