<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
<title>Copas与Lua的异步请求</title>
<meta name="keywords" content="Copas,请求,异步,Lua,thread,协程,LuaSocket,阻塞,超时,调度,进程" />
<link href="../css/han.css" rel="stylesheet">
</head>
<body class='typora-export os-windows' >
<div  id='write'  class = 'is-node'><h1><a name="copas与lua的异步请求" class="md-header-anchor"></a><span>Copas与Lua的异步请求</span></h1><p><span>这次的话题Copas算是我积压一段时间的一个坑，现在快过年了，终于有时间写了。</span></p><p><span>在Lua语言里，大家可能很少听到异步这个词。因为Lua本身是没有多线程的。但在JS中，我们已经非常习惯异步这个处理方式了。而且异步在处理多个请求中非常高效。在只是收发一两个请求的时候，异步不异步其实无所谓。但是在上百上千个请求的时候，异步的优势就很明显了。</span></p><p><span>Lua真的可以异步请求吗？很多人跟我一样曾经有这个疑问。因为大家对Lua单线程这个基本知识点的印象根深蒂固。虽然JS也算是单线程，但它有浏览器这个靠山啊，浏览器可以替它调度异步的请求，从而使它的异步请求完全不必阻塞。</span></p><p><span>那么在Lua如果像实现异步就有两条路可走</span></p><ol start='' ><li><span>利用协程（Coroutine）以及某种机制，在单线程里解决调度问题</span></li><li><span>利用宿主语言实现一个库，搞出多线程或者其他解决方案</span></li></ol><p><span>在lua-users的wiki上，</span><a href='http://lua-users.org/wiki/MultiTasking'><span>有一个页面</span></a><span>专门整理多任务处理的Lua库。这些库基本上也就是众多Lua的Web框架的基础，大家可以深入了解。这里面的分类比我科学一些，主要就是两大类，</span><strong><span>协作式</span></strong><span>（Cooperative）和</span><strong><span>抢占式</span></strong><span>（Preemptive）。</span></p><blockquote><p><span>协作式环境下，下一个进程被调度的前提是当前进程主动放弃时间片；抢占式环境下，操作系统完全决定进程调度方案，操作系统可以剥夺耗时长的进程的时间片，提供给其它进程。（维基百科）</span></p></blockquote><p><span>而基于协程的实现是属于协作式的。而Copas就是使用这种方式的一个库。我使用Copas并不是说推荐大家用Copas，而是因为两个小小的原因：</span></p><ol start='' ><li><span>Copas不用编译，是一个纯Lua库。</span></li><li><span>Copas使用的是Lua本身支持的协程</span></li></ol><p><span>在Lua的官方教程</span><a href='https://www.lua.org/pil/9.4.html'><span>PIL</span></a><span>中，就提到Copas所使用的dispatcher方案。要实现一个简单的Web服务器，确实有个dispatcher就足够了。原理其实就是一个永久循环，在循环里恢复执行协程。而异步的特性是通过LuaSocket的timeout实现的。它会把timeout设置为0，或者很小的数字。这样就能避免阻塞下面的循环。</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded md-focus" lang="lua" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap CodeMirror-focused" lang="lua"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 23px; left: 138px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre>x</pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">function</span> <span class="cm-variable">dispatcher</span> ()</span></pre></div><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">while</span> <span class="cm-keyword">true</span> <span class="cm-keyword">do</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">n</span> = <span class="cm-variable">table.getn</span>(<span class="cm-variable">threads</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">n</span> == <span class="cm-number">0</span> <span class="cm-keyword">then</span> <span class="cm-keyword">break</span> <span class="cm-keyword">end</span> &nbsp; <span class="cm-comment">-- no more threads to run</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">connections</span> = {}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">for</span> <span class="cm-variable">i</span>=<span class="cm-number">1</span>,<span class="cm-variable">n</span> <span class="cm-keyword">do</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">status</span>, <span class="cm-variable">res</span> = <span class="cm-builtin">coroutine.resume</span>(<span class="cm-variable">threads</span>[<span class="cm-variable">i</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-keyword">not</span> <span class="cm-variable">res</span> <span class="cm-keyword">then</span> &nbsp; &nbsp;<span class="cm-comment">-- thread finished its task?</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">table.remove</span>(<span class="cm-variable">threads</span>, <span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">break</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-keyword">else</span> &nbsp; &nbsp;<span class="cm-comment">-- timeout</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">table.insert</span>(<span class="cm-variable">connections</span>, <span class="cm-variable">res</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">table.getn</span>(<span class="cm-variable">connections</span>) == <span class="cm-variable">n</span> <span class="cm-keyword">then</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">socket.select</span>(<span class="cm-variable">connections</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">end</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 437px;"></div><div class="CodeMirror-gutters" style="display: none; height: 437px;"></div></div></div></pre><p><span>有同学可能会想问，超时之后不就接不到了嘛？但其实并不是这样。超时之后其实我们并没有关闭socket。从上面的示例代码中我们可以看出，超时的会在下一轮循环里继续请求，直至请求结束。在这种设定下，我们在进行HTTP请求的时候，就不用等待上一个请求出结果再继续下一个请求了。</span></p><p><span>但说实话，这种方式在一开始用的时候还是会有些不习惯的。还有就是，如果用的人不太了解细节可能达不到自己想要的效果。而Copas就是把它的实现细节封装了起来，虽然仍然避免不了加一个循环，但调用起来已经简单了不少。而且Copas在内部结合了LuaSocket和LuaSec，不用我们再分别引入这些库。</span></p><p><span>就比如，我在条目推送服务（</span><a href='https://github.com/AlexanderMisel/mwtest/blob/type/feed_service.lua'><span>mwtest/feed_service.lua</span></a><span>）里写的Copas HTTPS GET请求的函数</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="lua" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="lua"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><span><span>​</span>x</span></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">function</span> <span class="cm-variable">chttpsget</span>(<span class="cm-variable">req_url</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">MediaWikiApi.trace</span>(<span class="cm-string">'CHTTP request'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">res</span> = {}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">_</span>, <span class="cm-variable">code</span>, <span class="cm-variable">resheaders</span>, <span class="cm-variable">_</span> = <span class="cm-variable">chttp.request</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">url</span> = <span class="cm-variable">req_url</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">protocol</span> = <span class="cm-string">'tlsv1_2'</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">headers</span> = {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  [<span class="cm-string">'User-Agent'</span>] = <span class="cm-builtin">string.format</span>(<span class="cm-string">'mediawikilua %d.%d'</span>, <span class="cm-number">0</span>, <span class="cm-number">2</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  [<span class="cm-string">'Accept-Language'</span>] = <span class="cm-string">'zh-cn'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">sink</span> = <span class="cm-variable">ltn12.sink.table</span>(<span class="cm-variable">res</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">MediaWikiApi.trace</span>(<span class="cm-string">'  Result status:'</span>, <span class="cm-variable">code</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">return</span> <span class="cm-builtin">table.concat</span>(<span class="cm-variable">res</span>), <span class="cm-variable">code</span>, <span class="cm-variable">resheaders</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">end</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 368px;"></div><div class="CodeMirror-gutters" style="display: none; height: 368px;"></div></div></div></pre><p><span>可以说，这里的代码都已经比较上层了，不会再需要写直接处理套接字的代码。在Copas请求的最外层，一定要有一个</span><code>copas.addthread</code><span>，因为它会帮你创建一个Copas工作的函数，然后里面你进行什么操作都行。有人可能想问，在里面继续加thread行不行？当然可以。那我们加thread，和不加thread的区别在哪儿呢？</span></p><p><span>这里我就要解释一下了。Copas的每个thread的内部是阻塞的，但thread和外部、thread之间是不阻塞的。我们在一个请求之后，或许又要带出多个请求，就比如在feed_service里，我在第一个请求里获取到了热门条目列表之后，我要通过获取摘要接口，逐一获取条目的摘要。这时候，我们就需要在里面继续增加thread。代码大致如下：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="lua" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="lua"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">function</span> <span class="cm-variable">getTopView</span>(<span class="cm-variable">new_date</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">res</span>, <span class="cm-variable">code</span> = <span class="cm-variable">chttpsget</span>(<span class="cm-string">'https://wikimedia.org/api/rest_v1/metrics/'</span> ..</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">'pageviews/top/zh.wikipedia.org/all-access/'</span> .. <span class="cm-variable">data_str</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">code</span> ~= <span class="cm-number">200</span> <span class="cm-keyword">then</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-comment">-- Failed to get topviews</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">raw_topview</span> = <span class="cm-variable">json.decode</span>(<span class="cm-variable">res</span>).<span class="cm-variable">items</span>[<span class="cm-number">1</span>].<span class="cm-variable">articles</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">taskset</span> = <span class="cm-variable">limit.new</span>(<span class="cm-number">10</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">for</span> <span class="cm-variable">_</span>, <span class="cm-variable">v</span> <span class="cm-keyword">in</span> <span class="cm-builtin">ipairs</span>(<span class="cm-variable">raw_topview</span>) <span class="cm-keyword">do</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">art_name</span> = <span class="cm-variable">v.article</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-keyword">not</span> <span class="cm-variable">art_name</span>:<span class="cm-variable">match</span>(<span class="cm-string">':'</span>) <span class="cm-keyword">and</span> <span class="cm-keyword">not</span> <span class="cm-variable">list_match</span>(<span class="cm-variable">spamlist</span>, <span class="cm-variable">art_name</span>) <span class="cm-keyword">then</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">taskset</span>:<span class="cm-variable">addthread</span>(<span class="cm-keyword">function</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">disp_name</span>, <span class="cm-variable">extract</span> = <span class="cm-variable">getSummary</span>(<span class="cm-variable">art_name</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-keyword">end</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">end</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 414px;"></div><div class="CodeMirror-gutters" style="display: none; height: 414px;"></div></div></div></pre><p><span>大家可能注意到，我用了limit，这是我后来才加的。这是因为如果不加限制，会将所有的请求一下都塞给底层库，底层一下子同时请求会导致socket的select出现问题。而Copas自带的limit库就能解决这个问题。我把请求数限制在了10个以内，这样就不需要我人工去sleep解决这样的问题了。</span></p><p><span>到这里，大家对Copas的HTTP(S)请求应该有了一定了解。它的请求语法与LuaSocket是一致的。我最早其实是用LuaSec原生请求的，切换成Copas基本上就是引个lua文件的事。</span></p><hr /><p><span>这个feed_service在网络条件较好的情况下，可以说事又快又稳的。但是像维基百科这样的境外网站，难免会有访问慢的时候。另外就是，有时候不是慢，就是发1000个请求，总是有那么几个，它就是不响应。这样的话，Copas就会一直一直尝试，如果我没关注的话，也许几天都卡在那儿了。</span></p><p><span>因为推送热门条目这件事，本来也不需要保证100%都下载下来，失败几个没有关系。Copas只有</span><code>addthread</code><span>，却没有</span><code>removethread</code><span>。所以我对Copas进行了patch。加入了如下代码：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="lua"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="lua"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">function</span> <span class="cm-variable">copas.removeall</span>()</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">_reading</span> = <span class="cm-variable">newset</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">_writing</span> = <span class="cm-variable">newset</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">_sleeping.times</span> = {}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">end</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 115px;"></div><div class="CodeMirror-gutters" style="display: none; height: 115px;"></div></div></div></pre><p><span>在请求一段时间之后，我在主循环里调用这个函数，把Copas内部保留的请求干掉，恢复一个干净的Copas，这样就不会总卡在Copas上了。</span><a href='../' title='返回首页'><span>∎</span></a></p></div>
<script src="../dist/style_fix.js"></script>
<script src="../dist/mini_pangu.js"></script>
</body>
</html>