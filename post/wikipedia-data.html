<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
<title>维基百科数据处理两则</title>
<meta name="keywords" content="维基百科,数据处理,分类,covid19,2019,浏览量,冠狀病毒,疫情,摘要,热门" />
<link href="../css/han.css" rel="stylesheet">
</head>
<body class='typora-export' >
<div  id='write'  class = ''><h1><a name="维基百科数据处理两则" class="md-header-anchor"></a><span>维基百科数据处理两则</span></h1><p><span>这篇博客记录我处理维基百科数据的两次实践。想不到太好的标题，所以就用这个标题了。可能大家也发现，我在写技术博客的时候，不会只谈技术。我觉得想法是很重要的。我们程序员和其他人的差别我认为在于：能想到什么事情能编程去做，以及如果编程去做需要用到什么技术。比如我下文提到的两件事，其实说白了就是HTTP请求，再加上循环、判断处理。我大学四年没有学会如何用程序发HTTP请求，上班以后学会了，很开心。</span></p><p><span>在下面两项任务中，我都是调用维基百科的API来获取相应数据。我有一些朋友的第一思路居然会是爬网页。有API不调而去爬网页是给自己增加难度。维基百科的API我还是比较欣赏的，尤其是变量命名的一致，参数拼接方式的一致。</span></p><h2><a name="为维基百科年度热门条目分类" class="md-header-anchor"></a><span>为维基百科年度热门条目分类</span></h2><p><span>在维基百科上百万的条目中，每年年初都会进行排名，找到年度浏览量排名前列的条目。虽然社群以及媒体对这个列表都比较关注，但基金会每年放出这个列表的时间往往很迟，迟到让人感觉已经错过作为新闻发出来的时机。直到今年年初，我终于忍耐不住，用一个小程序在把12个月的排行前列的条目累加，得到一个近似的全年浏览量排行榜。越靠后排名越不准确，所以在公布的时候我一般都最多只公布前100名，所以准确性应该可以保证。</span></p><p><span>其实基金会是有开放数据库的，可以在网页界面查询一些过滤器啊、用户基本信息、条目基本信息（不包括条目正文），但浏览量数据库并不是一个开放的数据库，我觉得主要原因是数据量大，如果允许大家任意查询的话，基金会的土豆服务器撑不住，哈哈。另外我把12个月相加的原因也是，月度的浏览量排行是自动调接口的，但年度的结果则是由基金会统一计算好，导入到topviews的数据库里，实现年度数据的查询。之前甚至每年都需要去Phabricator（WMF在用的一种ticket系统）上请求基金会技术人员去计算。但人家是圣诞节假期，哪有心思给你算啊，所以就很迟。</span></p><p><span>无论是直接使用基金会统计的数据，还是自己累加，都会只拿到一个条目名称。我通常还希望了解条目的分类，从而了解热门条目的分布，以及某些分类中浏览量较多的条目。在前两年我都是纯手工进行分类。纯手工分类虽然准确，但也会浪费一些时间。当然，分类了两年，观察了三年，我也觉得可以尝试一下写程序进行分类了。一个很简单的原因，大家如果跟我一样关注的话应该是清楚的，维基百科浏览量排行在前列的条目每年都是那几个，就不怎么发生变化。今年唯一增加的复杂之处在于COVID-19。首先，COVID-19在今年的浏览量里有特殊地位，相关的条目不是一两个，而是一批，除了疫情本身，还有相关的人、不同国家的疫情都有条目。就像下面这张表列出的这样</span><sup class='md-footnote'><a href='#dfref-footnote-1' name='ref-footnote-1'>1</a></sup></p><figure><table><thead><tr><th><span>rank</span></th><th style='text-align:center;' ><span>title</span></th><th><span>views</span></th><th><span>type</span></th></tr></thead><tbody><tr><td><span>1</span></td><td style='text-align:center;' ><span>2019冠状病毒病疫情</span></td><td><span>9639339</span></td><td><span>covid19+event</span></td></tr><tr><td><span>12</span></td><td style='text-align:center;' ><span>2019冠狀病毒病全球各地疫情</span></td><td><span>2029179</span></td><td><span>covid19</span></td></tr><tr><td><span>51</span></td><td style='text-align:center;' ><span>2019冠状病毒病</span></td><td><span>921555</span></td><td><span>covid19</span></td></tr><tr><td><span>102</span></td><td style='text-align:center;' ><span>谭德塞</span></td><td><span>638593</span></td><td><span>covid19+person</span></td></tr><tr><td><span>128</span></td><td style='text-align:center;' ><span>志村健</span></td><td><span>536873</span></td><td><span>covid19+star</span></td></tr><tr><td><span>186</span></td><td style='text-align:center;' ><span>2019冠狀病毒病臺灣疫情</span></td><td><span>455327</span></td><td><span>covid19</span></td></tr><tr><td><span>188</span></td><td style='text-align:center;' ><span>李文亮</span></td><td><span>454478</span></td><td><span>covid19+person</span></td></tr><tr><td><span>216</span></td><td style='text-align:center;' ><span>鑽石公主號</span></td><td><span>424098</span></td><td><span>covid19</span></td></tr><tr><td><span>221</span></td><td style='text-align:center;' ><span>陈秋实 (律师)</span></td><td><span>417243</span></td><td><span>covid19+person</span></td></tr><tr><td><span>243</span></td><td style='text-align:center;' ><span>2019冠狀病毒病香港疫情</span></td><td><span>397039</span></td><td><span>covid19</span></td></tr><tr><td><span>449</span></td><td style='text-align:center;' ><span>2019冠狀病毒病美國疫情</span></td><td><span>262775</span></td><td><span>covid19</span></td></tr><tr><td><span>461</span></td><td style='text-align:center;' ><span>2019冠狀病毒病馬來西亞疫情</span></td><td><span>257657</span></td><td><span>covid19</span></td></tr><tr><td><span>528</span></td><td style='text-align:center;' ><span>2019冠狀病毒病日本疫情</span></td><td><span>234145</span></td><td><span>covid19</span></td></tr><tr><td><span>535</span></td><td style='text-align:center;' ><span>2019冠状病毒病意大利疫情</span></td><td><span>231108</span></td><td><span>covid19</span></td></tr><tr><td><span>628</span></td><td style='text-align:center;' ><span>2019冠狀病毒病韓國疫情</span></td><td><span>196579</span></td><td><span>covid19</span></td></tr></tbody></table></figure><p><span>我没有用到机器学习的算法，而是把它当作是一个普普通通的业务来写的。当然这得益于维基百科的分类网。在维基百科中，维基人会主动为条目加上分类，这些分类是人工加的，相当于我们的数据已经是带了标签的，这些标签对我分类有很大帮助。虽然我不是不能直接用这些标签，但我是通过这些标签中的关键字来识别对应条目的类别的。这些关键字也是我调试的一个重点，大致是下面这样的：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="lua" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="lua"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span class="cm-variable">cat_type</span> = {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  { <span class="cm-string">'演员#'</span>, <span class="cm-string">'star'</span> }, { <span class="cm-string">'歌手#'</span>, <span class="cm-string">'star'</span> }, { <span class="cm-string">'音乐团体'</span>, <span class="cm-string">'star'</span> },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  { <span class="cm-string">'年出生'</span>, <span class="cm-string">'person'</span> }, { <span class="cm-string">'年逝世'</span>, <span class="cm-string">'person'</span> },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  { <span class="cm-string">'城市#'</span>, <span class="cm-string">'place'</span> },  { <span class="cm-string">'国家#'</span>, <span class="cm-string">'place'</span> }, { <span class="cm-string">'政权#'</span>, <span class="cm-string">'place'</span> }, { <span class="cm-string">'共和国#'</span>, <span class="cm-string">'place'</span> }, { <span class="cm-string">'成员国#'</span>, <span class="cm-string">'place'</span> }, </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  { <span class="cm-string">'节日#'</span>, <span class="cm-string">'festival'</span> }, { <span class="cm-string">'主题日#'</span>, <span class="cm-string">'festival'</span> },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  { <span class="cm-string">'事件#'</span>, <span class="cm-string">'event'</span> }, { <span class="cm-string">'案件#'</span>, <span class="cm-string">'event'</span> }, { <span class="cm-string">'事故#'</span>, <span class="cm-string">'event'</span> },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  { <span class="cm-string">'网站#'</span>, <span class="cm-string">'website'</span> }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span class="cm-variable">cat_topic</span> = {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  { <span class="cm-string">'电视剧'</span>, <span class="cm-string">'drama'</span> }, { <span class="cm-string">'剧集'</span>, <span class="cm-string">'drama'</span> },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  { <span class="cm-string">'漫画'</span>, <span class="cm-string">'acg'</span> }, { <span class="cm-string">'动画'</span>, <span class="cm-string">'acg'</span> }, { <span class="cm-string">'游戏#'</span>, <span class="cm-string">'acg'</span> }, { <span class="cm-string">'角色列表'</span>, <span class="cm-string">'acg'</span> },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  { <span class="cm-string">'电影#'</span>, <span class="cm-string">'film'</span> },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  { <span class="cm-string">'色情'</span>, <span class="cm-string">'porn'</span> }, { <span class="cm-string">'性行为'</span>, <span class="cm-string">'porn'</span> }, { <span class="cm-string">'%f[%a]AV%f[%A]'</span>, <span class="cm-string">'porn'</span> }, </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  { <span class="cm-string">'党'</span>, <span class="cm-string">'politics'</span> }, { <span class="cm-string">'中共'</span>, <span class="cm-string">'politics'</span> }, { <span class="cm-string">'政治'</span>, <span class="cm-string">'politics'</span> }, { <span class="cm-string">'选举'</span>, <span class="cm-string">'politics'</span> },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  { <span class="cm-string">'军事'</span>, <span class="cm-string">'military'</span> }, { <span class="cm-string">'战争#'</span>, <span class="cm-string">'military'</span> }, { <span class="cm-string">'战役#'</span>, <span class="cm-string">'military'</span> },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  { <span class="cm-string">'真人秀'</span>, <span class="cm-string">'show'</span> }, { <span class="cm-string">'综艺'</span>, <span class="cm-string">'show'</span> }, { <span class="cm-string">'选秀'</span>, <span class="cm-string">'show'</span> }, { <span class="cm-string">'娱乐节目'</span>, <span class="cm-string">'show'</span> }, </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  { <span class="cm-string">'冠状病毒病'</span>, <span class="cm-string">'covid19'</span> },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  { <span class="cm-string">'病'</span>, <span class="cm-string">'medicine'</span> }, { <span class="cm-string">'药'</span>, <span class="cm-string">'medicine'</span> },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 484px;"></div><div class="CodeMirror-gutters" style="display: none; height: 484px;"></div></div></div></pre><p><span>我使用了两个层级的关键词，</span><code>cat_type</code><span>这个匹配会告诉我条目是什么类型的事物，</span><code>cat_topic</code><span>这个匹配会告诉我条目的主题是关于什么的。当然仅仅这样匹配，谁都会想到，会有错误划分。需要一些修正。我目前的修正仅仅是排除了带有下面两个关键词的分类：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="lua"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="lua"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span class="cm-variable">exclusion</span> = { <span class="cm-string">'党员'</span>, <span class="cm-string">'校友'</span> }</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>修正出现错误结果之后才会有的。为什么是这两个分类？因为我发现很多明星被标注成了“politics+star”，我认为这不正常，于是我找了几个样本看了一下，发现他们的分类是XX年入党的党员。我想党员不能说就跟政治挂钩，所以我要排除它。第二个修正“校友”，是因为我发现一个人可能是XX政治大学的校友，但他不能算作politics分类。</span></p><p><span>其实我还发现有意思的事情，就是“show+star”和“show+person”分类，为什么一个人还可以是show，再仔细分析之后，我发现这些几乎都是主持过综艺节目的人。所以我没有直接处理掉。数据稍加整理就可以做出类似下图这样的图表</span></p><div class="md-diagram-panel"><svg id="mermaidChart121" width="100%" xmlns="http://www.w3.org/2000/svg" height="100%" viewBox="0 0 674 450"><style>
:root { --mermaid-font-family: sans-serif}
:root { --mermaid-alt-font-family: sans-serif}</style><style></style><g></g><svg width="674" height="450"><g transform="translate(337,225)"><path d="M1.1327982892113017e-14,-185A185,185,0,0,1,184.31023920106801,15.960442526606206L0,0Z" fill="#66c2a5" stroke="black" style="stroke-width: 2px; opacity: 0.7;"></path><path d="M184.31023920106801,15.960442526606206A185,185,0,0,1,36.60319223389578,181.3427867831761L0,0Z" fill="#fc8d62" stroke="black" style="stroke-width: 2px; opacity: 0.7;"></path><path d="M36.60319223389578,181.3427867831761A185,185,0,0,1,-130.12922583129938,131.49670940577445L0,0Z" fill="#8da0cb" stroke="black" style="stroke-width: 2px; opacity: 0.7;"></path><path d="M-130.12922583129938,131.49670940577445A185,185,0,0,1,-184.96950804916372,3.3587336974448863L0,0Z" fill="#e78ac3" stroke="black" style="stroke-width: 2px; opacity: 0.7;"></path><path d="M-184.96950804916372,3.3587336974448863A185,185,0,0,1,-163.59417581928705,-86.3825540141538L0,0Z" fill="#a6d854" stroke="black" style="stroke-width: 2px; opacity: 0.7;"></path><path d="M-163.59417581928705,-86.3825540141538A185,185,0,0,1,-102.21912809613822,-154.19549231824283L0,0Z" fill="#ffd92f" stroke="black" style="stroke-width: 2px; opacity: 0.7;"></path><path d="M-102.21912809613822,-154.19549231824283A185,185,0,0,1,-66.47224914923177,-172.64541723730304L0,0Z" fill="#e5c494" stroke="black" style="stroke-width: 2px; opacity: 0.7;"></path><path d="M-66.47224914923177,-172.64541723730304A185,185,0,0,1,-44.349415235401516,-179.60548256742592L0,0Z" fill="#b3b3b3" stroke="black" style="stroke-width: 2px; opacity: 0.7;"></path><path d="M-44.349415235401516,-179.60548256742592A185,185,0,0,1,-21.529608990560288,-183.7429615977537L0,0Z" fill="#66c2a5" stroke="black" style="stroke-width: 2px; opacity: 0.7;"></path><path d="M-21.529608990560288,-183.7429615977537A185,185,0,0,1,-3.398394867633905e-14,-185L0,0Z" fill="#fc8d62" stroke="black" style="stroke-width: 2px; opacity: 0.7;"></path><text transform="translate(68.17044985496112,-62.52231414920781)" class="slice" style="text-anchor: middle; font-size: 17px;">26%</text><text transform="translate(68.9900644930889,61.61672663522004)" class="slice" style="text-anchor: middle; font-size: 17px;">20%</text><text transform="translate(-26.494988193968595,88.62429464092487)" class="slice" style="text-anchor: middle; font-size: 17px;">16%</text><text transform="translate(-85.03916484174341,36.394923313819355)" class="slice" style="text-anchor: middle; font-size: 17px;">12%</text><text transform="translate(-89.98268598461084,-21.432830494242275)" class="slice" style="text-anchor: middle; font-size: 17px;">8%</text><text transform="translate(-68.5817519187267,-62.070873231800334)" class="slice" style="text-anchor: middle; font-size: 17px;">8%</text><text transform="translate(-42.42433005250252,-82.1974830490346)" class="slice" style="text-anchor: middle; font-size: 17px;">3%</text><text transform="translate(-27.76000248376686,-88.23622987243539)" class="slice" style="text-anchor: middle; font-size: 17px;">2%</text><text transform="translate(-16.502205469442682,-91.01608217586767)" class="slice" style="text-anchor: middle; font-size: 17px;">2%</text><text transform="translate(-5.39156870047537,-92.34273651429253)" class="slice" style="text-anchor: middle; font-size: 17px;">2%</text><text x="0" y="-200" class="pieTitleText">中文维基分类热门条目数</text><g class="legend" transform="translate(216,-110)"><rect width="18" height="18" style="fill: rgb(102, 194, 165); stroke: rgb(102, 194, 165);"></rect><text x="22" y="14">star</text></g><g class="legend" transform="translate(216,-88)"><rect width="18" height="18" style="fill: rgb(252, 141, 98); stroke: rgb(252, 141, 98);"></rect><text x="22" y="14">others</text></g><g class="legend" transform="translate(216,-66)"><rect width="18" height="18" style="fill: rgb(141, 160, 203); stroke: rgb(141, 160, 203);"></rect><text x="22" y="14">drama</text></g><g class="legend" transform="translate(216,-44)"><rect width="18" height="18" style="fill: rgb(231, 138, 195); stroke: rgb(231, 138, 195);"></rect><text x="22" y="14">politics</text></g><g class="legend" transform="translate(216,-22)"><rect width="18" height="18" style="fill: rgb(166, 216, 84); stroke: rgb(166, 216, 84);"></rect><text x="22" y="14">acg</text></g><g class="legend" transform="translate(216,0)"><rect width="18" height="18" style="fill: rgb(255, 217, 47); stroke: rgb(255, 217, 47);"></rect><text x="22" y="14">person</text></g><g class="legend" transform="translate(216,22)"><rect width="18" height="18" style="fill: rgb(229, 196, 148); stroke: rgb(229, 196, 148);"></rect><text x="22" y="14">film</text></g><g class="legend" transform="translate(216,44)"><rect width="18" height="18" style="fill: rgb(179, 179, 179); stroke: rgb(179, 179, 179);"></rect><text x="22" y="14">medicine</text></g><g class="legend" transform="translate(216,66)"><rect width="18" height="18" style="fill: rgb(102, 194, 165); stroke: rgb(102, 194, 165);"></rect><text x="22" y="14">place</text></g><g class="legend" transform="translate(216,88)"><rect width="18" height="18" style="fill: rgb(252, 141, 98); stroke: rgb(252, 141, 98);"></rect><text x="22" y="14">covid19</text></g></g></svg></svg></div><p><span>可以看出中文维基的热门条目主要是明星、电视剧、政治、ACG和热点人物，这就是我说的历年不变的东西。COVID-19今年虽然挤进来了，但条目数量上不会占优势，当然占优势也就麻烦了，那样COVID-19影响面就太广了。</span></p><h2><a name="获取科学方面的条目" class="md-header-anchor"></a><span>获取科学方面的条目</span></h2><p><span>我一直有一个想法，就是通过维基百科的社群让大家更加了解和热爱科学。中文维基百科人文当道。也许我上面说的这句话不完全正确，但从我这个角度看，确实能感受到这一点。这或许与你们一部分人的认知不太一样。因为中国大陆的大家或许之所以听说维基百科，在用维基百科，也许就是听说维基百科的数理化条目比较强，深入但又好懂。</span></p><p><span>由于近年来某个阻碍越来越严重，可能能在大陆继续使用维基百科的，有一大批是我国的科技人才或者未来的科技人才。从我作为程序员看，我们领域中还算听说过维基百科的，可能比别的行业要多一些。但我的同行们对维基百科科技条目的贡献率让我失望。他们反而会去贡献那些人文条目，或者社会热点之流。当然我没有说贡献人文条目有问题，但是如果自己专业领域条目无人贡献的话，别人就更不会贡献了。</span></p><p><span>背景就说这么多。我的目标就是把维基百科的科学相关的条目摘要拿出来，作为群机器人推送条目的来源。我之前有过获取热门条目的经验，所以这个小目标其实是水到渠成的。因为在之前获取热门条目的代码编写过程中，我用到了异步发HTTP请求这方便的知识，并且有了尝试的经验。在写这个的时候，我直接就上异步，因为我知道同步请求有多慢。关于Lua异步请求方面，可以看我</span><a href='./copas-and-lua-async.html'><span>另一篇博客</span></a><span>。</span></p><p><span>我在这篇要主要介绍的是我的思路，以及在一些细节上的处理。上文提到了，维基百科的分类是网状结构的，并非是树状结构，分类与分类交织在一起，一个分类可以有多个父分类和多个子分类。直接上手去顺着分类摸，被前人证明是愚蠢的事情，容易摸到一个无关的父分类。并不是维基人加分类时不用心，而是维基的分类结构如此，维基人在一个底层条目加分类的时候，不会去考虑上层要经过什么样的路径才能到达一个基础分类。</span></p><p><span>还好我是一个还算了解维基百科的人，所以不会走这条路。我知道另一条路。它位于维基百科的条目的讨论页。维基百科不光条目有分类，讨论页也有分类。有时候讨论页的分类比条目的分类还好用。我想说的就是“维基专题”相关的分类，它们是通过条目评级模板加入的。根据我的了解，有些维基人非常热爱给条目评级，或许因为这是一个不需要写条目就可以刷编辑数的办法。</span><sup class='md-footnote'><a href='#dfref-footnote-2' name='ref-footnote-2'>2</a></sup></p><p><span>我选了这些分类作为数据来源。</span></p><pre lang="lua" class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="lua"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span class="cm-variable">sci_cats</span> = {</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string">'极高重要度数学条目'</span>, <span class="cm-string">'高重要度数学条目'</span>, <span class="cm-string">'中重要度数学条目'</span>,</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string">'极高重要度物理学条目'</span>, <span class="cm-string">'高重要度物理学条目'</span>, <span class="cm-string">'中重要度物理学条目'</span>,</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string">'极高重要度化学条目'</span>, <span class="cm-string">'高重要度化学条目'</span>, <span class="cm-string">'中重要度化学条目'</span>,</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string">'极高重要度生物学条目'</span>, <span class="cm-string">'高重要度生物学条目'</span>, <span class="cm-string">'中重要度生物学条目'</span>,</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string">'极高重要度医学条目'</span>, <span class="cm-string">'高重要度医学条目'</span>, <span class="cm-string">'中重要度医学条目'</span>,</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string">'极高重要度电脑和信息技术条目'</span>, <span class="cm-string">'高重要度电脑和信息技术条目'</span>, <span class="cm-string">'中重要度电脑和信息技术条目'</span>,</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 176px;"></div><div class="CodeMirror-gutters" style="display: none; height: 176px;"></div></div></div></pre><p><span>这几个分类非常顶用，从中能够拿到上万个条目，而且质量令人满意。有了条目名称，就需要获取摘要了。维基百科有两套API都能查条目的摘要，一种是RESTful的，一种是普通的URI参数的。可以说RESTful是相当好理解的，我之前获取每日热门条目的摘要就是用这套。但是苦在两点，一是每次请求只支持查一个条目，二是返回格式没得选，返回啥就只能认啥。</span></p><p><span>反观老式的api.php版接口，提供了HTML形式和plaintext格式的extract，摘要限制多长，摘要返回多少句话，多少个字符都可以控制。虽然，基金会在这方面处理的很垃圾，但至少灵活了。在灵活的基础上我就可以自己写处理函数了，自己处理HTML。我自己写处理函数的原因还有一个，那就是基金会在处理含有数学公式的摘要方面有硬伤，会导致格式混乱。在群友那里反馈也不好。下面就是我写的处理函数，也是我比较骄傲的地方：</span></p><pre lang="lua" class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="lua"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre>x</pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">function</span> <span class="cm-variable">stripHtmlTags</span>(<span class="cm-variable">extract</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">if</span> <span class="cm-keyword">not</span> <span class="cm-variable">extract</span> <span class="cm-keyword">then</span> <span class="cm-keyword">return</span> <span class="cm-string">''</span> <span class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">first_para</span> = <span class="cm-variable">extract</span>:<span class="cm-variable">match</span>(<span class="cm-string">'&lt;p&gt;(.-)\n?&lt;/p&gt;'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">if</span> <span class="cm-keyword">not</span> <span class="cm-variable">first_para</span> <span class="cm-keyword">then</span> <span class="cm-keyword">return</span> <span class="cm-string">''</span> <span class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">first_para</span> = <span class="cm-variable">first_para</span>:<span class="cm-variable">gsub</span>(<span class="cm-string">'&lt;span&gt;&lt;span&gt;&lt;math.-alttext="(.-)".-&lt;/span&gt;&lt;/span&gt;'</span>, </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">function</span>(<span class="cm-variable">p1</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">p1</span>:<span class="cm-variable">gsub</span>(<span class="cm-string">'%b{}'</span>, <span class="cm-keyword">function</span> (<span class="cm-variable">p2</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">p2</span>:<span class="cm-variable">gsub</span>(<span class="cm-string">'^{\\displaystyle (.-)}$'</span>, <span class="cm-keyword">function</span> (<span class="cm-variable">p3</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">p3</span>:<span class="cm-variable">match</span>(<span class="cm-string">'^%b{}$'</span>) <span class="cm-keyword">then</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-string">'$'</span> .. <span class="cm-variable">p3</span>:<span class="cm-variable">gsub</span>(<span class="cm-string">'^{(.*)}$'</span>, <span class="cm-string">'%1'</span>) .. <span class="cm-string">'$'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">else</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-string">'$'</span> .. <span class="cm-variable">p3</span> .. <span class="cm-string">'$'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">end</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">end</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">end</span>)</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">first_para</span> = <span class="cm-variable">first_para</span>:<span class="cm-variable">gsub</span>(<span class="cm-string">'%b&lt;&gt;'</span>, <span class="cm-string">''</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">for</span> <span class="cm-variable">uchar</span>, <span class="cm-variable">end_pos</span> <span class="cm-keyword">in</span> <span class="cm-variable">first_para</span>:<span class="cm-variable">gmatch</span>(<span class="cm-string">'([%z\1-\127\194-\244][\128-\191]*)()'</span>) <span class="cm-keyword">do</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">uchar</span> == <span class="cm-string">'。'</span> <span class="cm-keyword">or</span> <span class="cm-variable">uchar</span> == <span class="cm-string">'：'</span> <span class="cm-keyword">then</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">end_pos</span> &gt; <span class="cm-number">450</span> <span class="cm-keyword">then</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">first_para</span> = <span class="cm-variable">first_para</span>:<span class="cm-variable">sub</span>(<span class="cm-number">1</span>, <span class="cm-variable">end_pos</span> - <span class="cm-number">1</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">break</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">first_para</span></span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">end</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 616px;"></div><div class="CodeMirror-gutters" style="display: none; height: 616px;"></div></div></div></pre><p><span>我把公式干干净净地去得只剩下一个LaTeX表达式，符合那些学术狗的口味。缺少公式的科学条目会影响阅读的，所以必须留着。HTML标签也使用Lua专属的</span><code>%b&lt;&gt;</code><span>模式匹配轻松去掉了。</span></p><p><span>我之所以最近写这个是因为我最近修复了这个程序的一点小问题。这个小问题跟URL Encode有关。以后如果GET请求导致后端报错，浏览器上却正常的话，可以考虑一下把含有中文的参数encode一下。浏览器是默认encode的，但你的程序如果不主动进行这个编码，或者用的库比较底层，可能并未encode。另外我还做了失败重发的操作，在网络条件不好的情况下，失败重发还是挺管事的。</span><a href='../' title='返回首页'><span>∎</span></a></p><p>&nbsp;</p><div class='footnotes-area'  ><hr/>
<div class='footnote-line'><span class='md-fn-count'>1</span> <span>数据来自2020年1-7月的浏览量</span> <a name='dfref-footnote-1' href='#ref-footnote-1' title='回到文档' class='reversefootnote' >↩</a></div>
<div class='footnote-line'><span class='md-fn-count'>2</span> <span>也许不是维基人的你们无法理解，在维基百科上，编辑数就是能力的重要代表，就是话语权。如果你没编过几个条目，你就开始对维基百科指手画脚的话，能够想象在站内没什么人会搭理你。</span> <a name='dfref-footnote-2' href='#ref-footnote-2' title='回到文档' class='reversefootnote' >↩</a></div></div></div>
<script src="../dist/style_fix.js"></script>
<script src="../dist/mini_pangu.js"></script>
</body>
</html>