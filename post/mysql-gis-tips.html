<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
<title>MySQL处理GIS数据</title>
<meta name="keywords" content="GIS,MySQL,MariaDB,经纬度,空间索引,空间分析,行政区划" />
<link href="../css/han.css" rel="stylesheet">
</head>
<body class='typora-export'><div class='typora-export-content'>
<div id='write'  class=''><h1 id='mysql处理gis数据'><span>MySQL处理GIS数据</span></h1><p><span>本文所涉及的MySQL经验均以MariaDB 10.5为基础。我上周末在百忙之中重装了Deepin操作系统。因为上一次更新不知道遇到什么问题，系统启动不了。排查原因无果，于是重装最新版Deepin。问题解决。但既然是重装，我以前的软件有一些就没了。其中就包含MySQL数据库。</span></p><h2 id='重装mariadb过程'><span>重装MariaDB过程</span></h2><p><span>上次安装的部分过程我在</span><a href='chores.html'><span>这篇博客</span></a><span>中已经提到过了。没错，我还是用的官方脚本。毕竟Deepin是一个软件仓库更新缓慢的distro。我自然不可能因此就安装Deepin仓库里的10.3版本。毕竟10.5是一个大更新。</span></p><p><span>重装跟第一次安装的大部分步骤都是相同的。需要注意的是要把数据目录重新设定到之前的地方。我设置错了好几回，但是最终设置正确之后，MySQL就正常启动了。</span></p><p><span>我之前把数据目录放在了/home/mysql/data这个路径里。这没什么。但是我重装系统以后，数据目录的owner就变成我了，应该设置成mysql:mysql才对。总之，这都不是难事。</span></p><h2 id='导入csv数据'><span>导入csv数据</span></h2><p><span>这次导入csv可是让我费了劲了。如果有navicat的话应该会轻松搞定，但是在咱们清真的Linux下，我自然不可能去装什么盗版的Navicat。虽然有一个DBeaver可以使用，但我之前用它的感受不爽，不想再安装了。这次我选择了一个冷门GUI，叫做Beekeeper Studio，是一款开源软件。但是功能有点简陋，没有方便的直接导入csv。于是我尝试用语句导入。也就是</span><code>LOAD DATA</code><span>语句啦。</span></p><p><span>但是我尝试了很多次都不成功，老是卡在data truncated for column的问题。我想到印象中，我安装的MariaDB的类型验证好像是比MySQL 5.7严一些啊，于是我查了一下，应该是默认的sql_mode影响了这一点</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">show</span> <span class="cm-keyword">variables</span> <span class="cm-keyword">like</span> <span class="cm-string">'%sql_mode%'</span><span class="cm-punctuation">;</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>我看了下这个值是多少</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.75px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">IGNORE_SPACE,STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 44px;"></div><div class="CodeMirror-gutters" style="display: none; height: 44px;"></div></div></div></pre><p><span>就是这个STRICT_TRANS_TABLES影响了我们。于是通过</span><code>SET GLOBAL sql_mode</code><span>把它干掉了。</span></p><p><span>当然还有其他问题，就是GIS数据类型导入的麻烦之处。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="mysql"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="mysql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">LOAD</span> <span class="cm-keyword">DATA</span> <span class="cm-keyword">INFILE</span> <span class="cm-string">'/home/alexander/coding/map/railway_china.csv'</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">INTO</span> <span class="cm-keyword">TABLE</span> railway_china</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">FIELDS</span> <span class="cm-keyword">TERMINATED</span> <span class="cm-keyword">BY</span> <span class="cm-string">','</span> <span class="cm-keyword">OPTIONALLY</span> <span class="cm-keyword">ENCLOSED</span> <span class="cm-keyword">BY</span> <span class="cm-string">'"'</span> <span class="cm-keyword">ESCAPED</span> <span class="cm-keyword">BY</span> <span class="cm-string">'\\'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">LINES</span> <span class="cm-keyword">TERMINATED</span> <span class="cm-keyword">BY</span> <span class="cm-string">'\r\n'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">IGNORE</span> <span class="cm-number">1</span> <span class="cm-keyword">LINES</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-bracket">(</span>id<span class="cm-punctuation">,</span> name<span class="cm-punctuation">,</span> <span class="cm-variable-2">@var3</span><span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">SET</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">location <span class="cm-operator">=</span> GeomFromText<span class="cm-bracket">(</span><span class="cm-variable-2">@var3</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 176px;"></div><div class="CodeMirror-gutters" style="display: none; height: 176px;"></div></div></div></pre><p><span>注意行尾符是什么很重要。如果你是Windows类的换行CRLF，一定不要写成</span><code>\n</code><span>，那样会报一个</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Row 1 was truncated; it contained more data than there were input columns</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>这个错有各种原因都有可能引起，所以你在网上找解决方法，也容易找不对。</span></p><h2 id='如何提高地理位置数据的准确度'><span>如何提高地理位置数据的准确度</span></h2><p><span>我前几周没事就在想这个问题。解决这个问题无非是两个路子：一个是靠人力，一个是靠程序自动比对。本文中我主要想提的是，通过MySQL在库中排查数据中的问题。</span></p><h3 id='通过不同来源的经纬度比对'><span>通过不同来源的经纬度比对</span></h3><p><span>第一方面，我想排查数据中重复的情况。尤其是在OSM这种数据集中，出现同一个地方被标了两次的情况还是蛮常见的。在其他的数据中，这类情况其实也是存在。以前，我一直思路都局限在通过名称去匹配，然后检验其他数据，包括地理位置数据。但最近我想要改改思路。我要通过地理位置去聚合，找到距离近的点。如果两个火车站的距离在1000米以内，那这件事是不是会有点奇怪呢？所以我选择了这个距离。而且我发现如果这个距离扩大到2000米以至3000米的时候，这个数据就有可能出错了。</span></p><p><span>我初步的想法是利用MySQL提供的</span><code>ST_Distance_Sphere</code><span>函数，但发现MariaDB目前不支持，要到10.5.10版本之后才会支持。我是这么写的</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">SELECT</span> <span class="cm-operator">*</span> <span class="cm-keyword">FROM</span> railway_china t1<span class="cm-punctuation">,</span> railway_china t2</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">WHERE</span> ST_Distance_Sphere<span class="cm-bracket">(</span>t1<span class="cm-variable-2">.location</span><span class="cm-punctuation">,</span> t2<span class="cm-variable-2">.location</span><span class="cm-bracket">)</span> <span class="cm-operator">&lt;</span> <span class="cm-number">1000</span> <span class="cm-keyword">AND</span> t1<span class="cm-variable-2">.id</span> <span class="cm-operator">&lt;</span> t2<span class="cm-variable-2">.id</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 44px;"></div><div class="CodeMirror-gutters" style="display: none; height: 44px;"></div></div></div></pre><p><span>但是既然不能用，那我也可以把距离除以111195，来近似比较距离了。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">SELECT</span> <span class="cm-operator">*</span> <span class="cm-keyword">FROM</span> railway_china t1<span class="cm-punctuation">,</span> railway_china t2</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">WHERE</span> ST_Distance<span class="cm-bracket">(</span>t1<span class="cm-variable-2">.location</span><span class="cm-punctuation">,</span> t2<span class="cm-variable-2">.location</span><span class="cm-bracket">)</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0.009</span> <span class="cm-keyword">AND</span> t1<span class="cm-variable-2">.id</span> <span class="cm-operator">&lt;</span> t2<span class="cm-variable-2">.id</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 44px;"></div><div class="CodeMirror-gutters" style="display: none; height: 44px;"></div></div></div></pre><p><span>但这两种方案有一个共同的问题，那就是用不上空间索引。为什么用不上索引？很简单，因为ST_Distance类的函数天生就只考虑算出一个距离，没有考虑固定其中一个，来缩小查找的范围。它的两个参数是平等的。而下面这个函数，MBRContains，天生就想着框定一个范围，所以就会用上索引。这也就是为什么我在网上找到MySQL专家写的这个写法。为了适应MBRContains，构造一个类圆的多边形，从而帮助框定范围。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">SELECT</span> <span class="cm-operator">*</span> <span class="cm-keyword">FROM</span> railway_china t1<span class="cm-punctuation">,</span> railway_china t2</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">WHERE</span> t1<span class="cm-variable-2">.id</span> <span class="cm-operator">&lt;</span> t2<span class="cm-variable-2">.id</span> <span class="cm-keyword">AND</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">MBRContains<span class="cm-bracket">(</span>polygon_circle<span class="cm-bracket">(</span>ST_X<span class="cm-bracket">(</span>t1<span class="cm-variable-2">.location</span><span class="cm-bracket">)</span><span class="cm-punctuation">,</span> ST_Y<span class="cm-bracket">(</span>t1<span class="cm-variable-2">.location</span><span class="cm-bracket">)</span><span class="cm-punctuation">,</span> <span class="cm-number">0.009</span><span class="cm-punctuation">,</span> <span class="cm-number">6</span><span class="cm-bracket">)</span><span class="cm-punctuation">,</span> t2<span class="cm-variable-2">.location</span><span class="cm-bracket">)</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 88px;"></div><div class="CodeMirror-gutters" style="display: none; height: 88px;"></div></div></div></pre><p><span>但这需要编写一个polygon_circle函数。需要比较高超的SQL技术</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.75px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">CREATE</span> <span class="cm-keyword">FUNCTION</span> polygon_circle<span class="cm-bracket">(</span>pX <span class="cm-builtin">DOUBLE</span><span class="cm-punctuation">,</span> pY <span class="cm-builtin">DOUBLE</span><span class="cm-punctuation">,</span> pDiameter <span class="cm-builtin">DOUBLE</span><span class="cm-punctuation">,</span> pPoints <span class="cm-keyword">SMALLINT</span> <span class="cm-builtin">UNSIGNED</span><span class="cm-bracket">)</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- RETURNS VARCHAR(4096) DETERMINISTIC</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">RETURNS</span> POLYGON <span class="cm-keyword">DETERMINISTIC</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">BEGIN</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">DECLARE</span> i <span class="cm-keyword">SMALLINT</span> <span class="cm-builtin">UNSIGNED</span> <span class="cm-keyword">DEFAULT</span> <span class="cm-number">0</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">DECLARE</span> vSteps <span class="cm-keyword">SMALLINT</span> <span class="cm-builtin">UNSIGNED</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">DECLARE</span> vPolygon <span class="cm-builtin">VARCHAR</span><span class="cm-bracket">(</span><span class="cm-number">4096</span><span class="cm-bracket">)</span> <span class="cm-keyword">DEFAULT</span> <span class="cm-string">''</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment">-- Input validation</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">IF</span> pPoints <span class="cm-operator">&lt;</span> <span class="cm-number">3</span> <span class="cm-keyword">THEN</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">RETURN</span> <span class="cm-atom">NULL</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">END</span> <span class="cm-keyword">IF</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">IF</span> pPoints <span class="cm-operator">&gt;</span> <span class="cm-number">360</span> <span class="cm-keyword">THEN</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">RETURN</span> <span class="cm-atom">NULL</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">END</span> <span class="cm-keyword">IF</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">IF</span> pPoints <span class="cm-operator">&gt;</span> <span class="cm-number">90</span> <span class="cm-keyword">THEN</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">RETURN</span> <span class="cm-atom">NULL</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">END</span> <span class="cm-keyword">IF</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">if</span> <span class="cm-bracket">(</span><span class="cm-number">360</span> <span class="cm-operator">%</span> pPoints<span class="cm-bracket">)</span> <span class="cm-operator">!=</span> <span class="cm-number">0</span> <span class="cm-keyword">THEN</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">RETURN</span> <span class="cm-atom">NULL</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">END</span> <span class="cm-keyword">IF</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment">-- Start</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">SET</span> vSteps <span class="cm-operator">=</span> <span class="cm-number">360</span> / pPoints<span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">WHILE</span> i <span class="cm-operator">&lt;</span> <span class="cm-number">360</span> <span class="cm-keyword">DO</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">SET</span> vPolygon <span class="cm-operator">=</span> CONCAT<span class="cm-bracket">(</span>vPolygon<span class="cm-punctuation">,</span> <span class="cm-bracket">(</span>pX <span class="cm-operator">+</span> <span class="cm-bracket">(</span>SIN<span class="cm-bracket">(</span>i <span class="cm-operator">*</span> <span class="cm-number">2</span> <span class="cm-operator">*</span> PI<span class="cm-bracket">()</span> / <span class="cm-number">360</span><span class="cm-bracket">)</span> <span class="cm-operator">*</span> pDiameter<span class="cm-bracket">))</span><span class="cm-punctuation">,</span> <span class="cm-string">' '</span><span class="cm-punctuation">,</span> <span class="cm-bracket">(</span>pY <span class="cm-operator">+</span> <span class="cm-bracket">(</span>COS<span class="cm-bracket">(</span>i <span class="cm-operator">*</span> <span class="cm-number">2</span> <span class="cm-operator">*</span> PI<span class="cm-bracket">()</span> / <span class="cm-number">360</span><span class="cm-bracket">)</span> <span class="cm-operator">*</span> pDiameter<span class="cm-bracket">))</span><span class="cm-punctuation">,</span> <span class="cm-string">', '</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">SET</span> i <span class="cm-operator">=</span> i <span class="cm-operator">+</span> vSteps<span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">END</span> <span class="cm-keyword">WHILE</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment">-- Add first point again</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">SET</span> vPolygon <span class="cm-operator">=</span> CONCAT<span class="cm-bracket">(</span><span class="cm-string">"POLYGON(("</span><span class="cm-punctuation">,</span> vPolygon<span class="cm-punctuation">,</span> <span class="cm-bracket">(</span>pX <span class="cm-operator">+</span> <span class="cm-bracket">(</span>SIN<span class="cm-bracket">(</span><span class="cm-number">0</span> <span class="cm-operator">*</span> <span class="cm-number">2</span> <span class="cm-operator">*</span> PI<span class="cm-bracket">()</span> / <span class="cm-number">360</span><span class="cm-bracket">)</span> <span class="cm-operator">*</span> pDiameter<span class="cm-bracket">))</span><span class="cm-punctuation">,</span> <span class="cm-string">" "</span><span class="cm-punctuation">,</span> &nbsp;<span class="cm-bracket">(</span>pY <span class="cm-operator">+</span> <span class="cm-bracket">(</span>COS<span class="cm-bracket">(</span><span class="cm-number">0</span> <span class="cm-operator">*</span> <span class="cm-number">2</span> <span class="cm-operator">*</span> PI<span class="cm-bracket">()</span> / <span class="cm-number">360</span><span class="cm-bracket">)</span> <span class="cm-operator">*</span> pDiameter<span class="cm-bracket">))</span><span class="cm-punctuation">,</span> <span class="cm-string">"))"</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment">-- RETURN vPolygon;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">RETURN</span> ST_GeomFromText<span class="cm-bracket">(</span>vPolygon<span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">END</span><span class="cm-punctuation">;</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 924px;"></div><div class="CodeMirror-gutters" style="display: none; height: 924px;"></div></div></div></pre><h3 id='通过与行政区划对比'><span>通过与行政区划对比</span></h3><p><span>行政区划的边界数据属于很容易拿到的公开数据之一，也是我们判断一个经纬度是否正确的一个基础手段。我这里展示其中一种手段给大家看，就是用现成的高德数据。高德提供了行政区划边界的接口，我们可以从DataV那里拿到数据。那我们写一段小JS来处理我们的数据吧。我提前下载好了河北省各个地市的内部区县数据，使用Deno脚本处理一下</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="js"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="js"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-def">gcoord</span> <span class="cm-keyword">from</span> <span class="cm-string">'./gcoord/index.ts'</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> (<span class="cm-keyword">let</span> <span class="cm-def">n</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">n</span> <span class="cm-operator">&lt;</span> <span class="cm-number">12</span>; <span class="cm-variable">n</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">let</span> <span class="cm-def">fileName</span> <span class="cm-operator">=</span> <span class="cm-string-2">`13${</span><span class="cm-variable">String</span>(<span class="cm-variable">n</span>).<span class="cm-property">padStart</span>(<span class="cm-number">2</span>, <span class="cm-string">'0'</span>)<span class="cm-string-2">}00.json`</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">const</span> <span class="cm-def">text</span> <span class="cm-operator">=</span> <span class="cm-keyword">await</span> <span class="cm-variable">Deno</span>.<span class="cm-property">readTextFile</span>(<span class="cm-string">'gaode_data/'</span> <span class="cm-operator">+</span> <span class="cm-variable-2">fileName</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">const</span> <span class="cm-def">geojson</span> <span class="cm-operator">=</span> <span class="cm-variable">JSON</span>.<span class="cm-property">parse</span>(<span class="cm-variable-2">text</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">gcoord</span>.<span class="cm-property">transform</span>(<span class="cm-variable-2">geojson</span>, <span class="cm-variable">gcoord</span>.<span class="cm-property">GCJ02</span>, <span class="cm-variable">gcoord</span>.<span class="cm-property">WGS84</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">Deno</span>.<span class="cm-property">writeTextFile</span>(<span class="cm-variable-2">fileName</span>, <span class="cm-variable">JSON</span>.<span class="cm-property">stringify</span>(<span class="cm-variable-2">geojson</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 198px;"></div><div class="CodeMirror-gutters" style="display: none; height: 198px;"></div></div></div></pre><p><span>我这次用了一个公开的库gcoord来处理高德的边界数据，因为它的介绍中说支持GeoJSON格式的转换。然后我们要做的就是入库，把这些GeoJSON导入到我们的MySQL数据库。</span><sup class='md-footnote'><a href='#dfref-footnote-1' name='ref-footnote-1'>1</a></sup><span> 然后我们随手写段Lua脚本就能导入数据库了。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="lua" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="lua"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span class="cm-variable">json</span> = <span class="cm-builtin">require</span>(<span class="cm-string">'cjson'</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span class="cm-variable">fs</span> = <span class="cm-builtin">require</span>(<span class="cm-string">'fs'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span class="cm-variable">mysql</span> = <span class="cm-builtin">require</span>(<span class="cm-string">'mysql'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">mysql.bind</span>(<span class="cm-string">'mariadb'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span class="cm-variable">conn</span> = <span class="cm-variable">mysql.connect</span>(<span class="cm-string">'localhost'</span>, <span class="cm-string">'root'</span>, <span class="cm-string">'password'</span>, <span class="cm-string">'demo'</span>, <span class="cm-string">'utf8mb4'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span class="cm-variable">new_features</span> = {}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span class="cm-keyword">function</span> <span class="cm-variable">wrap_value</span>(<span class="cm-variable">a</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">a</span> <span class="cm-keyword">then</span> <span class="cm-keyword">return</span> <span class="cm-string">'"'</span> .. <span class="cm-variable">a</span> .. <span class="cm-string">'"'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">else</span> <span class="cm-keyword">return</span> <span class="cm-string">'NULL'</span> <span class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span class="cm-keyword">function</span> <span class="cm-variable">get_geojson</span>(<span class="cm-variable">geom</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">return</span> <span class="cm-string">'{"type":"'</span> .. <span class="cm-variable">geom.type</span> .. <span class="cm-string">'","coordinates":'</span> ..</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">json.encode</span>(<span class="cm-variable">geom.coordinates</span>) .. <span class="cm-string">'}'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> <span class="cm-variable">name</span>, <span class="cm-variable">d</span> <span class="cm-keyword">in</span> <span class="cm-variable">fs.dir</span>() <span class="cm-keyword">do</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">d</span>:<span class="cm-variable">attr</span><span class="cm-string">'type'</span> == <span class="cm-string">'file'</span> <span class="cm-keyword">and</span> <span class="cm-variable">name</span>:<span class="cm-variable">match</span>(<span class="cm-string">'[.]json$'</span>) <span class="cm-keyword">then</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-builtin">io.input</span>(<span class="cm-variable">name</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">geojson</span> = <span class="cm-variable">json.decode</span>(<span class="cm-builtin">io.read</span>(<span class="cm-string">'*all'</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">for</span> <span class="cm-variable">i</span>, <span class="cm-variable">v</span> <span class="cm-keyword">in</span> <span class="cm-builtin">ipairs</span>(<span class="cm-variable">geojson.features</span>) <span class="cm-keyword">do</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">v.geometry.type</span> ~= <span class="cm-string">'Point'</span> <span class="cm-keyword">then</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">conn</span>:<span class="cm-variable">query</span>(<span class="cm-string">[[INSERT INTO county_boundary (name, adcode, geom)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">VALUES (]]</span> .. </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">wrap_value</span>(<span class="cm-variable">v.properties</span>[<span class="cm-string">'name'</span>]) .. <span class="cm-string">','</span> ..</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">wrap_value</span>(<span class="cm-variable">v.properties</span>[<span class="cm-string">'adcode'</span>]) .. <span class="cm-string">','</span> ..</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">[[ST_GeomFromGeoJSON(']]</span> .. <span class="cm-variable">get_geojson</span>(<span class="cm-variable">v.geometry</span>) .. <span class="cm-string">[[')]]</span> ..</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">[[)]]</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">end</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 814px;"></div><div class="CodeMirror-gutters" style="display: none; height: 814px;"></div></div></div></pre><p><span>是不是很容易呢？记得给geom这个字段加上空间索引（先设置为非空，不然无法设置空间索引）</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">ALTER</span> <span class="cm-keyword">TABLE</span> county_boundary <span class="cm-keyword">MODIFY</span> <span class="cm-variable-2">`geom`</span> geometry <span class="cm-keyword">NOT</span> <span class="cm-atom">NULL</span><span class="cm-punctuation">;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">ALTER</span> <span class="cm-keyword">TABLE</span> county_boundary <span class="cm-keyword">ADD</span> <span class="cm-keyword">SPATIAL</span> <span class="cm-keyword">INDEX</span><span class="cm-bracket">(</span>geom<span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 44px;"></div><div class="CodeMirror-gutters" style="display: none; height: 44px;"></div></div></div></pre><p><span>好的来看看我们用来验证的数据（部分）</span></p><figure><table><thead><tr><th><span>id</span></th><th><span>name</span></th><th><span>location</span></th></tr></thead><tbody><tr><td><span>576</span></td><td><span>北戴河火车站</span></td><td><span>{&quot;x&quot;:119.426578,&quot;y&quot;:39.856995}</span></td></tr><tr><td><span>577</span></td><td><span>石家庄火车站</span></td><td><span>{&quot;x&quot;:114.495968,&quot;y&quot;:38.048038}</span></td></tr><tr><td><span>578</span></td><td><span>邯郸火车站</span></td><td><span>{&quot;x&quot;:114.482702,&quot;y&quot;:36.609316}</span></td></tr><tr><td><span>579</span></td><td><span>沧州火车站</span></td><td><span>{&quot;x&quot;:116.884334,&quot;y&quot;:38.315644}</span></td></tr><tr><td><span>580</span></td><td><span>衡水火车站</span></td><td><span>{&quot;x&quot;:115.697478,&quot;y&quot;:37.74999}</span></td></tr><tr><td><span>581</span></td><td><span>邢台火车站</span></td><td><span>{&quot;x&quot;:114.498746,&quot;y&quot;:37.075952}</span></td></tr><tr><td><span>582</span></td><td><span>保定火车站</span></td><td><span>{&quot;x&quot;:115.487222,&quot;y&quot;:38.868748}</span></td></tr><tr><td><span>583</span></td><td><span>昌黎火车站</span></td><td><span>{&quot;x&quot;:119.174245,&quot;y&quot;:39.710207}</span></td></tr><tr><td><span>584</span></td><td><span>任丘火车站</span></td><td><span>{&quot;x&quot;:116.151497,&quot;y&quot;:38.700304}</span></td></tr></tbody></table></figure><p><span>我们现在与之前建立好的区划边界表进行关联</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">SELECT</span> t1.<span class="cm-operator">*</span><span class="cm-punctuation">,</span> t2<span class="cm-variable-2">.name</span><span class="cm-punctuation">,</span> t2<span class="cm-variable-2">.adcode</span> <span class="cm-keyword">FROM</span> railway_hb_test t1 <span class="cm-keyword">JOIN</span> county_boundary t2</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">ON</span> ST_Contains<span class="cm-bracket">(</span>t2<span class="cm-variable-2">.geom</span><span class="cm-punctuation">,</span> t1<span class="cm-variable-2">.location</span><span class="cm-bracket">)</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 44px;"></div><div class="CodeMirror-gutters" style="display: none; height: 44px;"></div></div></div></pre><p><span>我们看到结果秒出。得到的结果符合我们的预期</span></p><figure><table><thead><tr><th><span>id</span></th><th><span>name</span></th><th><span>location</span></th><th><span>name</span></th><th><span>adcode</span></th></tr></thead><tbody><tr><td><span>575</span></td><td><span>唐山火车站</span></td><td><span>{&quot;x&quot;:118.125417,&quot;y&quot;:39.631415}</span></td><td><span>路北区</span></td><td><span>130203</span></td></tr><tr><td><span>576</span></td><td><span>北戴河火车站</span></td><td><span>{&quot;x&quot;:119.426578,&quot;y&quot;:39.856995}</span></td><td><span>北戴河区</span></td><td><span>130304</span></td></tr><tr><td><span>577</span></td><td><span>石家庄火车站</span></td><td><span>{&quot;x&quot;:114.495968,&quot;y&quot;:38.048038}</span></td><td><span>长安区</span></td><td><span>130102</span></td></tr><tr><td><span>578</span></td><td><span>邯郸火车站</span></td><td><span>{&quot;x&quot;:114.482702,&quot;y&quot;:36.609316}</span></td><td><span>丛台区</span></td><td><span>130403</span></td></tr><tr><td><span>579</span></td><td><span>沧州火车站</span></td><td><span>{&quot;x&quot;:116.884334,&quot;y&quot;:38.315644}</span></td><td><span>新华区</span></td><td><span>130902</span></td></tr><tr><td><span>580</span></td><td><span>衡水火车站</span></td><td><span>{&quot;x&quot;:115.697478,&quot;y&quot;:37.74999}</span></td><td><span>桃城区</span></td><td><span>131102</span></td></tr><tr><td><span>581</span></td><td><span>邢台火车站</span></td><td><span>{&quot;x&quot;:114.498746,&quot;y&quot;:37.075952}</span></td><td><span>襄都区</span></td><td><span>130502</span></td></tr><tr><td><span>582</span></td><td><span>保定火车站</span></td><td><span>{&quot;x&quot;:115.487222,&quot;y&quot;:38.868748}</span></td><td><span>莲池区</span></td><td><span>130606</span></td></tr><tr><td><span>583</span></td><td><span>昌黎火车站</span></td><td><span>{&quot;x&quot;:119.174245,&quot;y&quot;:39.710207}</span></td><td><span>昌黎县</span></td><td><span>130322</span></td></tr><tr><td><span>584</span></td><td><span>任丘火车站</span></td><td><span>{&quot;x&quot;:116.151497,&quot;y&quot;:38.700304}</span></td><td><span>任丘市</span></td><td><span>130982</span></td></tr></tbody></table></figure><hr /><p><span>这次我主要介绍了MySQL中处理地理坐标数据的一些经验。GIS功能是现代数据库中非常有用的一项功能，常见的数据库一般都会有这方面功能，只不过大家可能没有学到或者用到。我这边算是把这方面知识简单的给大家展现一下，也只是冰山一角。</span></p><p><img src="../img/checkpoint_analysis.png" referrerpolicy="no-referrer" alt="checkpoint_analysis"></p><p><span>事实上我也尝试了其他不同的方法，就比如用高速公路来分析沿线的GA检查站的数据的准确性，由于数据中还额外包含道路信息，我们还可以分析经纬度距离道路的距离（如上图），我就不展开讲了。方法都一样，大家可以尝试一下自己工作中用到的数据，看看是否能够利用GIS分析，发现更多可能性。</span><a href='../' title='返回首页'><span>∎</span></a></p><div class='footnotes-area'  ><hr/>
<div class='footnote-line'><span class='md-fn-count'>1</span> <span>其实如果只是处理本地文件，不用MySQL也可以，找个JS库，比如下篇博客我会给大家介绍的turfjs就可以批量处理。我这里介绍导入数据库是为了方便处理数据库中的批量数据。</span> <a name='dfref-footnote-1' href='#ref-footnote-1' title='回到文档' class='reversefootnote' >↩</a></div></div></div></div>
<script src="../dist/style_fix.js"></script>
<script src="../dist/mini_pangu.js"></script>
</body>
</html>