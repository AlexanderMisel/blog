<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
<title>LPeg与PEG文法实践</title>
<meta name="keywords" content="PEG,解析表达文法,解析表达式文法,LPeg,匹配,文法,递归,Lua,正则表达式,规则" />
<link href="../css/han.css" rel="stylesheet">
</head>
<body class='typora-export os-windows' >
<div  id='write'  class = 'is-node'><h1><a name='header-n0' class='md-header-anchor '></a>LPeg与PEG文法实践</h1><p>看过我之前的博客的人应该知道，我已经成为一个Luar了。Lua现在是我第二常用语言，我业余生活的第一常用语言。我工作中最常用的语言是JavaScript，因为我是一个前端嘛。在提LPeg之前我首先还是要提一下当今在所有语言中几乎都必备的一个部分，那就是模式匹配。</p><p>因为我不是一个计算机专业的毕业生，我在大学并没有在课堂上学到过有关模式匹配的知识。我们首先看看模式匹配是什么：<sup class='md-footnote'><a href='#dfref-footnote-1' name='ref-footnote-1'>1</a></sup></p><blockquote><p>计算机科学中的<strong>模式匹配</strong>是检查和定位原始数据或标记序列中某种模式的特定数据序列。</p><p>-- techopedia</p></blockquote><p>我也看了维基百科和百度百科的定义，但说得不是很明白，所以我才找的其他来源上的定义。在现代编程中，模式匹配最常用的方式应该就是<strong>正则表达式</strong>了（在课本上也会称作<strong>正规式</strong>），这个大家应该都听过。我在工作过程中，应该已经是频繁使用正则表达式了。在JS中，在字符串中查找替换基本上就会用到正则表达式。</p><p>Lua的字符串库中也支持了类似正则表达式的语法。不过Lua自带的模式匹配比我们常用的正则表达式要精简很多，也会有很多难以表达的模式。当然我不是说Lua自带的不好。从极简主义的角度看，这一点是极好的，毕竟其实Lua自带的模式可以满足大部分需要。而且据说，只要是Lua自带的模式匹配能匹配的，效率比PCRE（一种正则表达式标准）还要快。所以我也在程序中能用自带的就用自带的。</p><p>不过我一直知道，Lua有一个强大的匹配库，也是Lua的作者Roberto Ierusalimschy推出的，叫做<strong>LPeg</strong>，它不但可以弥补Lua原生匹配的不足，甚至比正则表达式的表达能力要更强。但说实话，它的文档写得并不好。例子少，函数怎么使用介绍得也不清楚。所以我一开始能避开就选择避开了。但是，大家也知道，我几个月前开始使用一款编辑器，叫做Textadept。这个编辑器的所有语法高亮都是采用LPeg编写的。而且可以用非常少量代码来编写一种语言的lexer（词法分析器）。这就让人很感兴趣。</p><p>拿我写的一小段解析Markdown语法的代码为例，给大家看看LPeg是如何发挥作用的。</p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="lua" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="lua"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><span><span>​</span>x</span></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span class="cm-variable">punct_space</span> = <span class="cm-variable">lexer.punct</span> + <span class="cm-variable">lexer.space</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- Handles flanking delimiters as described in</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- https://github.github.com/gfm/#emphasis-and-strong-emphasis in the cases</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- where simple delimited ranges are not sufficient.</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span class="cm-keyword">function</span> <span class="cm-variable">flanked_range</span>(<span class="cm-variable">s</span>, <span class="cm-variable">not_inword</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">fl_char</span> = <span class="cm-variable">lexer.any</span> - <span class="cm-variable">s</span> - <span class="cm-variable">lexer.space</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">left_fl</span> = <span class="cm-variable">lpeg.B</span>(<span class="cm-variable">punct_space</span> - <span class="cm-variable">s</span>) * <span class="cm-variable">s</span> * #<span class="cm-variable">fl_char</span> +</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">s</span> * #(<span class="cm-variable">fl_char</span> - <span class="cm-variable">lexer.punct</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">right_fl</span> = <span class="cm-variable">lpeg.B</span>(<span class="cm-variable">lexer.punct</span>) * <span class="cm-variable">s</span> * #(<span class="cm-variable">punct_space</span> - <span class="cm-variable">s</span>) +</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">lpeg.B</span>(<span class="cm-variable">fl_char</span>) * <span class="cm-variable">s</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">left_fl</span> * (<span class="cm-variable">lexer.any</span> - (<span class="cm-variable">not_inword</span> <span class="cm-keyword">and</span> <span class="cm-variable">s</span> * #<span class="cm-variable">punct_space</span> <span class="cm-keyword">or</span> <span class="cm-variable">s</span>))^<span class="cm-number">0</span> *</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">right_fl</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">lex</span>:<span class="cm-variable">add_rule</span>(<span class="cm-string">'strong'</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">token</span>(<span class="cm-string">'strong'</span>, <span class="cm-variable">flanked_range</span>(<span class="cm-string">'**'</span>) +</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="cm-variable">lpeg.B</span>(<span class="cm-variable">punct_space</span>) + #<span class="cm-variable">lexer.starts_line</span>(<span class="cm-string">'_'</span>)) *</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">flanked_range</span>(<span class="cm-string">'__'</span>, <span class="cm-keyword">true</span>) * #(<span class="cm-variable">punct_space</span> + -<span class="cm-number">1</span>)))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">lex</span>:<span class="cm-variable">add_style</span>(<span class="cm-string">'strong'</span>, <span class="cm-string">'bold'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">lex</span>:<span class="cm-variable">add_rule</span>(<span class="cm-string">'em'</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">token</span>(<span class="cm-string">'em'</span>, <span class="cm-variable">flanked_range</span>(<span class="cm-string">'*'</span>) +</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="cm-variable">lpeg.B</span>(<span class="cm-variable">punct_space</span>) + #<span class="cm-variable">lexer.starts_line</span>(<span class="cm-string">'_'</span>)) *</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">flanked_range</span>(<span class="cm-string">'_'</span>, <span class="cm-keyword">true</span>) * #(<span class="cm-variable">punct_space</span> + -<span class="cm-number">1</span>)))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">lex</span>:<span class="cm-variable">add_style</span>(<span class="cm-string">'em'</span>, <span class="cm-string">'italics'</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 598px;"></div><div class="CodeMirror-gutters" style="display: none; height: 598px;"></div></div></div></pre><p>这段代码是出现在Textadept的Markdown lexer中的，所以用到了一些Textadept在lexer.lua里定义好的。这段代码描述的是Markdown中倾斜以及加粗的语法。如果你比较了解Markdown的话，应该知道*是可以用在单词中的，而_不可以。根据Markdown的规范，就会有下面这些：</p><ul><li><code>foo*bar*</code>的效果是foo<em>bar</em>，而<code>foo_bar_</code>的效果是foo_bar_。</li><li><code>a * foo bar*</code>不会倾斜，<code>foo-_(bar)_</code>会倾斜，<code>_foo_bar_baz_</code>会整体倾斜成<em>foo_bar_baz</em></li><li><code>_(bar)_?</code>因为最后是标点符号，依然是可以用下划线的，显示效果是 <em>(bar)</em>?</li></ul><p>说实话我见过很多自称实现Markdown解析的，在这里都做得不符合标准。但用这么几行Lua代码结合LPeg，就可以非常接近标准（因为是代码编辑器，我没有考虑嵌套加粗与倾斜的）。</p><hr /><p>由于我的目的不是写教程，所以上面的例子也不是给大家展示最基础的东西。下面我们再谈回LPeg。那么LPeg究竟是什么呢？我们需要先了解一下<strong>PEG</strong>，也就是<strong>解析表达文法</strong>（Parsing Expression Grammar）。我们搬出维基百科：</p><blockquote><p>解析表达文法是一种分析型形式文法。这种文法用一个识别字符串的规则的集合来描述某种形式语言。</p></blockquote><p>为什么说是<strong>分析型</strong>的呢。我前一段时间特地为大家翻译了维基百科的<a href='https://zh.wikipedia.org/wiki/%E5%BD%A2%E5%BC%8F%E6%96%87%E6%B3%95'>形式文法</a>条目。里面有提到，分析型文法是和大家熟知的<strong>乔姆斯基谱系</strong>不同的体系。分析型文法更注重与语法分析器的结构和语义的对应，我在使用的时候也能感受出来，它的思维比CFG更加直接。在你用PEG定义一个文法的时候，你会自然地绕过CFG中的一些循环定义，而PEG本身也会保证文法不会出现二义性。同时它的实际<strong>表达性</strong>（Expressivity）至少也是超出正则表达式的。</p><p>我曾经有一段时间一直以为LPeg不支持懒惰匹配的。这个问题一直是阻碍我继续探索LPeg的一个因素。我在使用LPeg前期一直都是看着官方文档做的。而我前面也说了，官方文档的例子真的有限，所以有些关键部分是了解不到的。直到我最近为了实现Textadept的JS的自动补全，我打开了一篇关于PEG的论文，才真正懂了一点。这篇论文就摆在LPeg官网最上面，但是我一直在看文档，没读过这个。我看了论文才体会到，如果想真正会用LPeg，只看文档是不行的，弄懂PEG才行。这篇论文就是《<a href='http://www.inf.puc-rio.br/~roberto/docs/peg.pdf'>A Text Pattern-Matching Tool based on Parsing Expression Grammars</a>》，是Roberto写的，涉及到了PEG的知识，以及LPeg中PEG的具体实现。</p><p>有关PEG有两个我认为的关键词：<strong>有限制的回溯</strong>（restricted backtracking）与<strong>有序选择</strong>（ordered choice）。</p><ul><li><strong>有限制的回溯</strong>说的是PEG只进行<strong>局部</strong>回溯，也就是说，它只会在一个规则内部有多个选项的地方回溯。只要其中一个选项匹配成功，那么就算这个规则后面匹配不成功，也不会在返回来再取下一个选项，或者把某个<code>*</code>或<code>+</code>匹配长度缩短来试着匹配。这与正则表达式以及Lua原生的模式匹配都遵循的<strong>最长匹配原则</strong>不同。</li><li><strong>有序选择</strong>是说PEG里面对于多个选项的规则，用的是<code>/</code>运算符，这叫做有序选择运算符。这就与CFG中的<code>|</code>运算符存在着本质的不同了。选择上了第一个，就不会再考虑第二个。</li></ul><p>这样的规则一开始可能会觉得限制了我们意思的表达。但事实上，它的表达能力依然很强大，对于编程语言来说是够用的。而且它带来的好处稍微想一下就能知道，相比CFG来说，避免了二义性；而相比于正则表达式而言，它匹配的时间是可预测的，因为它有严格的性能模型。虽然维基百科上说，据推测，存在不能用PEG处理的上下文无关语言，但毕竟尚未得到证实。据我所知，Lua本身、JavaScript、CSS，以及<a href='https://github.com/daurnimator/lpeg_patterns'>多种数据</a>都有已实现的PEG解析。</p><p>上面提到的那篇论文给我们展示了实现贪婪匹配、懒惰匹配、肯定预查和否定预查，不需要对PEG进行任何的扩展。</p><hr /><p>我之前会有LPeg不支持懒惰匹配的疑问其实是对PEG了解不深才会这样的。其实我那时只会“盲目”贪婪匹配，也是没有回溯的一种贪婪匹配。盲目地匹配尽量多个E<sub>1</sub>，然后跟着匹配E<sub>2</sub>的规则很简单，就是</p><div contenteditable="false" spellcheck="false" class="mathjax-block md-end-block md-math-block md-rawblock" id="mathjax-n37" cid="n37" mdtype="math_block"><div class="md-rawblock-container md-math-container" tabindex="-1"><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="-1" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="93.3681px" height="24.0625px" viewBox="0 -806.1 4695.2 1210.2" role="img" focusable="false" style="vertical-align: -0.938ex; max-width: 100%;"><defs><path stroke-width="0" id="E1-MJMAIN-53" d="M55 507Q55 590 112 647T243 704H257Q342 704 405 641L426 672Q431 679 436 687T446 700L449 704Q450 704 453 704T459 705H463Q466 705 472 699V462L466 456H448Q437 456 435 459T430 479Q413 605 329 646Q292 662 254 662Q201 662 168 626T135 542Q135 508 152 480T200 435Q210 431 286 412T370 389Q427 367 463 314T500 191Q500 110 448 45T301 -21Q245 -21 201 -4T140 27L122 41Q118 36 107 21T87 -7T78 -21Q76 -22 68 -22H64Q61 -22 55 -16V101Q55 220 56 222Q58 227 76 227H89Q95 221 95 214Q95 182 105 151T139 90T205 42T305 24Q352 24 386 62T420 155Q420 198 398 233T340 281Q284 295 266 300Q261 301 239 306T206 314T174 325T141 343T112 367T85 402Q55 451 55 507Z"></path><path stroke-width="0" id="E1-MJMAIN-2190" d="M944 261T944 250T929 230H165Q167 228 182 216T211 189T244 152T277 96T303 25Q308 7 308 0Q308 -11 288 -11Q281 -11 278 -11T272 -7T267 2T263 21Q245 94 195 151T73 236Q58 242 55 247Q55 254 59 257T73 264Q121 283 158 314T215 375T247 434T264 480L267 497Q269 503 270 505T275 509T288 511Q308 511 308 500Q308 493 303 475Q293 438 278 406T246 352T215 315T185 287T165 270H929Q944 261 944 250Z"></path><path stroke-width="0" id="E1-MJMATHI-45" d="M492 213Q472 213 472 226Q472 230 477 250T482 285Q482 316 461 323T364 330H312Q311 328 277 192T243 52Q243 48 254 48T334 46Q428 46 458 48T518 61Q567 77 599 117T670 248Q680 270 683 272Q690 274 698 274Q718 274 718 261Q613 7 608 2Q605 0 322 0H133Q31 0 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H757Q764 676 764 669Q764 664 751 557T737 447Q735 440 717 440H705Q698 445 698 453L701 476Q704 500 704 528Q704 558 697 578T678 609T643 625T596 632T532 634H485Q397 633 392 631Q388 629 386 622Q385 619 355 499T324 377Q347 376 372 376H398Q464 376 489 391T534 472Q538 488 540 490T557 493Q562 493 565 493T570 492T572 491T574 487T577 483L544 351Q511 218 508 216Q505 213 492 213Z"></path><path stroke-width="0" id="E1-MJMAIN-2217" d="M229 286Q216 420 216 436Q216 454 240 464Q241 464 245 464T251 465Q263 464 273 456T283 436Q283 419 277 356T270 286L328 328Q384 369 389 372T399 375Q412 375 423 365T435 338Q435 325 425 315Q420 312 357 282T289 250L355 219L425 184Q434 175 434 161Q434 146 425 136T401 125Q393 125 383 131T328 171L270 213Q283 79 283 63Q283 53 276 44T250 35Q231 35 224 44T216 63Q216 80 222 143T229 213L171 171Q115 130 110 127Q106 124 100 124Q87 124 76 134T64 161Q64 166 64 169T67 175T72 181T81 188T94 195T113 204T138 215T170 230T210 250L74 315Q65 324 65 338Q65 353 74 363T98 374Q106 374 116 368T171 328L229 286Z"></path><path stroke-width="0" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path stroke-width="0" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="#E1-MJMAIN-53" x="0" y="0"></use><use xlink:href="#E1-MJMAIN-2190" x="833" y="0"></use><g transform="translate(2111,0)"><use xlink:href="#E1-MJMATHI-45" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#E1-MJMAIN-2217" x="1091" y="452"></use><use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="1043" y="-434"></use></g><g transform="translate(3503,0)"><use xlink:href="#E1-MJMATHI-45" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="1043" y="-213"></use></g></g></svg></span></div><script type="math/tex; mode=display" id="MathJax-Element-1">\text{S} \leftarrow E_1^* \, E_2</script></div></div><p>说实话一般来说盲目就够用了。在E<sub>1</sub>不是E<sub>2</sub>的前缀的情况下，盲目与非盲目应该是等价的。</p><hr /><p>而“非盲目”的<strong>贪婪匹配</strong>多个E<sub>1</sub>，然后接一个E<sub>2</sub>的写法是</p><div contenteditable="false" spellcheck="false" class="mathjax-block md-end-block md-math-block md-rawblock" id="mathjax-n41" cid="n41" mdtype="math_block"><div class="md-rawblock-container md-math-container" tabindex="-1"><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="-1" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="120.313px" height="22.0486px" viewBox="0 -806.1 6050.7 1109.7" role="img" focusable="false" style="vertical-align: -0.705ex; max-width: 100%;"><defs><path stroke-width="0" id="E2-MJMAIN-53" d="M55 507Q55 590 112 647T243 704H257Q342 704 405 641L426 672Q431 679 436 687T446 700L449 704Q450 704 453 704T459 705H463Q466 705 472 699V462L466 456H448Q437 456 435 459T430 479Q413 605 329 646Q292 662 254 662Q201 662 168 626T135 542Q135 508 152 480T200 435Q210 431 286 412T370 389Q427 367 463 314T500 191Q500 110 448 45T301 -21Q245 -21 201 -4T140 27L122 41Q118 36 107 21T87 -7T78 -21Q76 -22 68 -22H64Q61 -22 55 -16V101Q55 220 56 222Q58 227 76 227H89Q95 221 95 214Q95 182 105 151T139 90T205 42T305 24Q352 24 386 62T420 155Q420 198 398 233T340 281Q284 295 266 300Q261 301 239 306T206 314T174 325T141 343T112 367T85 402Q55 451 55 507Z"></path><path stroke-width="0" id="E2-MJMAIN-2190" d="M944 261T944 250T929 230H165Q167 228 182 216T211 189T244 152T277 96T303 25Q308 7 308 0Q308 -11 288 -11Q281 -11 278 -11T272 -7T267 2T263 21Q245 94 195 151T73 236Q58 242 55 247Q55 254 59 257T73 264Q121 283 158 314T215 375T247 434T264 480L267 497Q269 503 270 505T275 509T288 511Q308 511 308 500Q308 493 303 475Q293 438 278 406T246 352T215 315T185 287T165 270H929Q944 261 944 250Z"></path><path stroke-width="0" id="E2-MJMATHI-45" d="M492 213Q472 213 472 226Q472 230 477 250T482 285Q482 316 461 323T364 330H312Q311 328 277 192T243 52Q243 48 254 48T334 46Q428 46 458 48T518 61Q567 77 599 117T670 248Q680 270 683 272Q690 274 698 274Q718 274 718 261Q613 7 608 2Q605 0 322 0H133Q31 0 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H757Q764 676 764 669Q764 664 751 557T737 447Q735 440 717 440H705Q698 445 698 453L701 476Q704 500 704 528Q704 558 697 578T678 609T643 625T596 632T532 634H485Q397 633 392 631Q388 629 386 622Q385 619 355 499T324 377Q347 376 372 376H398Q464 376 489 391T534 472Q538 488 540 490T557 493Q562 493 565 493T570 492T572 491T574 487T577 483L544 351Q511 218 508 216Q505 213 492 213Z"></path><path stroke-width="0" id="E2-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path stroke-width="0" id="E2-MJMAIN-2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z"></path><path stroke-width="0" id="E2-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="#E2-MJMAIN-53" x="0" y="0"></use><use xlink:href="#E2-MJMAIN-2190" x="833" y="0"></use><g transform="translate(2111,0)"><use xlink:href="#E2-MJMATHI-45" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#E2-MJMAIN-31" x="1043" y="-213"></use></g><use xlink:href="#E2-MJMAIN-53" x="3469" y="0"></use><use xlink:href="#E2-MJMAIN-2F" x="4192" y="0"></use><g transform="translate(4859,0)"><use xlink:href="#E2-MJMATHI-45" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#E2-MJMAIN-32" x="1043" y="-213"></use></g></g></svg></span></div><script type="math/tex; mode=display" id="MathJax-Element-2">\text{S} \leftarrow E_1 \,\text{S}\, /\, E_2</script></div></div><p>这个规则会一直尝试匹配E<sub>1</sub>，直到匹配匹配不到E<sub>1</sub>了。如果这时候匹配不到E<sub>2</sub>，这个匹配不会就此结束，因为每一层递归我们都选择了第一个选项，而我们还没有匹配成功，所以我们依然在局部回溯的范围中。PEG引擎会回溯到上一层，尝试选择第二个选项E<sub>2</sub>，如果再次不匹配又会再回溯到上一层递归，直到匹配成功。这时匹配的结果一定是最多个数的E<sub>1</sub>，后面跟一个E<sub>2</sub>。</p><hr /><p>再来说<strong>懒惰匹配</strong>。懒惰匹配多个E<sub>1</sub>，然后接一个E<sub>2</sub>的写法是</p><div contenteditable="false" spellcheck="false" class="mathjax-block md-end-block md-math-block md-rawblock" id="mathjax-n45" cid="n45" mdtype="math_block"><div class="md-rawblock-container md-math-container" tabindex="-1"><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="-1" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="120.313px" height="22.0486px" viewBox="0 -806.1 6050.7 1109.7" role="img" focusable="false" style="vertical-align: -0.705ex; max-width: 100%;"><defs><path stroke-width="0" id="E3-MJMAIN-53" d="M55 507Q55 590 112 647T243 704H257Q342 704 405 641L426 672Q431 679 436 687T446 700L449 704Q450 704 453 704T459 705H463Q466 705 472 699V462L466 456H448Q437 456 435 459T430 479Q413 605 329 646Q292 662 254 662Q201 662 168 626T135 542Q135 508 152 480T200 435Q210 431 286 412T370 389Q427 367 463 314T500 191Q500 110 448 45T301 -21Q245 -21 201 -4T140 27L122 41Q118 36 107 21T87 -7T78 -21Q76 -22 68 -22H64Q61 -22 55 -16V101Q55 220 56 222Q58 227 76 227H89Q95 221 95 214Q95 182 105 151T139 90T205 42T305 24Q352 24 386 62T420 155Q420 198 398 233T340 281Q284 295 266 300Q261 301 239 306T206 314T174 325T141 343T112 367T85 402Q55 451 55 507Z"></path><path stroke-width="0" id="E3-MJMAIN-2190" d="M944 261T944 250T929 230H165Q167 228 182 216T211 189T244 152T277 96T303 25Q308 7 308 0Q308 -11 288 -11Q281 -11 278 -11T272 -7T267 2T263 21Q245 94 195 151T73 236Q58 242 55 247Q55 254 59 257T73 264Q121 283 158 314T215 375T247 434T264 480L267 497Q269 503 270 505T275 509T288 511Q308 511 308 500Q308 493 303 475Q293 438 278 406T246 352T215 315T185 287T165 270H929Q944 261 944 250Z"></path><path stroke-width="0" id="E3-MJMATHI-45" d="M492 213Q472 213 472 226Q472 230 477 250T482 285Q482 316 461 323T364 330H312Q311 328 277 192T243 52Q243 48 254 48T334 46Q428 46 458 48T518 61Q567 77 599 117T670 248Q680 270 683 272Q690 274 698 274Q718 274 718 261Q613 7 608 2Q605 0 322 0H133Q31 0 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H757Q764 676 764 669Q764 664 751 557T737 447Q735 440 717 440H705Q698 445 698 453L701 476Q704 500 704 528Q704 558 697 578T678 609T643 625T596 632T532 634H485Q397 633 392 631Q388 629 386 622Q385 619 355 499T324 377Q347 376 372 376H398Q464 376 489 391T534 472Q538 488 540 490T557 493Q562 493 565 493T570 492T572 491T574 487T577 483L544 351Q511 218 508 216Q505 213 492 213Z"></path><path stroke-width="0" id="E3-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path stroke-width="0" id="E3-MJMAIN-2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z"></path><path stroke-width="0" id="E3-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="#E3-MJMAIN-53" x="0" y="0"></use><use xlink:href="#E3-MJMAIN-2190" x="833" y="0"></use><g transform="translate(2111,0)"><use xlink:href="#E3-MJMATHI-45" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#E3-MJMAIN-32" x="1043" y="-213"></use></g><use xlink:href="#E3-MJMAIN-2F" x="3469" y="0"></use><g transform="translate(4136,0)"><use xlink:href="#E3-MJMATHI-45" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#E3-MJMAIN-31" x="1043" y="-213"></use></g><use xlink:href="#E3-MJMAIN-53" x="5494" y="0"></use></g></svg></span></div><script type="math/tex; mode=display" id="MathJax-Element-3">\text{S} \leftarrow E_2\, /\, E_1\,\text{S}</script></div></div><p>这个规则会一层层递归，每次都先匹配E<sub>2</sub>，不匹配则尝试多匹配一个E<sub>1</sub>。只要匹配到一个E<sub>2</sub>，这个递归就会结束。所以这个规则匹配的是最少个数的E<sub>1</sub>，后面跟一个E<sub>2</sub>。</p><hr /><p>另外还有一点需要注意，那就是标准的PEG不支持<strong>左递归</strong>（left recursion）的。那么什么是左递归呢？我们再次搬出维基百科</p><blockquote><p>若一个非终结符号（non-terminal）<code>r</code>有任何直接的文法规则或者透过多个文法规则，推导出的句型（sentential form）其中最左边的符号又会出现<code>r</code>，则我们说这个非终结符号r是左递归的。 </p></blockquote><p>而左递归又可分为<strong>直接左递归</strong>和<strong>间接左递归</strong>。我就简单举个直接左递归例子，方便大家理解它的意思</p><div contenteditable="false" spellcheck="false" class="mathjax-block md-end-block md-math-block md-rawblock" id="mathjax-n52" cid="n52" mdtype="math_block"><div class="md-rawblock-container md-math-container" tabindex="-1"><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-4-Frame" tabindex="-1" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="109.41px" height="22.0486px" viewBox="0 -806.1 5501.6 1109.7" role="img" focusable="false" style="vertical-align: -0.705ex; max-width: 100%;"><defs><path stroke-width="0" id="E4-MJMAIN-53" d="M55 507Q55 590 112 647T243 704H257Q342 704 405 641L426 672Q431 679 436 687T446 700L449 704Q450 704 453 704T459 705H463Q466 705 472 699V462L466 456H448Q437 456 435 459T430 479Q413 605 329 646Q292 662 254 662Q201 662 168 626T135 542Q135 508 152 480T200 435Q210 431 286 412T370 389Q427 367 463 314T500 191Q500 110 448 45T301 -21Q245 -21 201 -4T140 27L122 41Q118 36 107 21T87 -7T78 -21Q76 -22 68 -22H64Q61 -22 55 -16V101Q55 220 56 222Q58 227 76 227H89Q95 221 95 214Q95 182 105 151T139 90T205 42T305 24Q352 24 386 62T420 155Q420 198 398 233T340 281Q284 295 266 300Q261 301 239 306T206 314T174 325T141 343T112 367T85 402Q55 451 55 507Z"></path><path stroke-width="0" id="E4-MJMAIN-2190" d="M944 261T944 250T929 230H165Q167 228 182 216T211 189T244 152T277 96T303 25Q308 7 308 0Q308 -11 288 -11Q281 -11 278 -11T272 -7T267 2T263 21Q245 94 195 151T73 236Q58 242 55 247Q55 254 59 257T73 264Q121 283 158 314T215 375T247 434T264 480L267 497Q269 503 270 505T275 509T288 511Q308 511 308 500Q308 493 303 475Q293 438 278 406T246 352T215 315T185 287T165 270H929Q944 261 944 250Z"></path><path stroke-width="0" id="E4-MJMAIN-58" d="M270 0Q252 3 141 3Q46 3 31 0H23V46H40Q129 50 161 88Q165 94 244 216T324 339Q324 341 235 480T143 622Q133 631 119 634T57 637H37V683H46Q64 680 172 680Q297 680 318 683H329V637H324Q307 637 286 632T263 621Q263 618 322 525T384 431Q385 431 437 511T489 593Q490 595 490 599Q490 611 477 622T436 637H428V683H437Q455 680 566 680Q661 680 676 683H684V637H667Q585 634 551 599Q548 596 478 491Q412 388 412 387Q412 385 514 225T620 62Q628 53 642 50T695 46H726V0H717Q699 3 591 3Q466 3 445 0H434V46H440Q454 46 476 51T499 64Q499 67 463 124T390 238L353 295L350 292Q348 290 343 283T331 265T312 236T286 195Q219 88 218 84Q218 70 234 59T272 46H280V0H270Z"></path><path stroke-width="0" id="E4-MJMAIN-2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z"></path><path stroke-width="0" id="E4-MJMAIN-2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="#E4-MJMAIN-53" x="0" y="0"></use><use xlink:href="#E4-MJMAIN-2190" x="833" y="0"></use><g transform="translate(2111,0)"><use xlink:href="#E4-MJMAIN-53"></use><use xlink:href="#E4-MJMAIN-58" x="806" y="0"></use></g><use xlink:href="#E4-MJMAIN-2F" x="3834" y="0"></use><use xlink:href="#E4-MJMAIN-2E" x="4334" y="0"></use><use xlink:href="#E4-MJMAIN-2E" x="4778" y="0"></use><use xlink:href="#E4-MJMAIN-2E" x="5223" y="0"></use></g></svg></span></div><script type="math/tex; mode=display" id="MathJax-Element-4">\text{S} \leftarrow \text{S X}\, / ...</script></div></div><p>虽然近年来多篇论文研究了系统性消除左递归的方式，但无论是LPeg和PEG.js都没有支持左递归。其实我想，或许Roberto不想去支持左递归。他想鼓励人们去写格式良好（well-formed）的PEG，而非借助编程的方法去化解左递归。</p><hr /><p>我也是看到了上面神奇的用法，才对LPeg重新恢复信心的。而且随后我又看到了另一篇论文《<a href='https://www.sciencedirect.com/science/article/pii/S0167642312002171'>From regexes to parsing expression grammars</a>》，这篇论文详细介绍了如何把正则表达式转换为PEG，并附有严格的证明。这也就印证了我前面说的，它拥有超出正则表达式的表达性。</p><p>LPeg有两种风格，一种就像我前面那个例子那样，作者喜欢称它为SNOBOL风格，但我更喜欢叫它“编程式”风格；另一种，作者喜欢称为正则式风格，但我更喜欢称它为“标准式”风格（因为论文里都会采用这种风格）。两种各有好处，编程式方便进行编程和扩展，可以定义一些函数处理捕获，扩展性较强；而标准式呢，我认为便于理解PEG文法的含义，因为呢，加号+我觉得让人感受不到有序选择的意味。我很久以来都没清晰地意识到，LPeg进行的是有序选择。而且编程式的捕获种类太多，什么Cb、Cc、Cf、Cg、Cp，让人看着眼晕，但是在标准式里，我就觉得好很多了。再次拿我写的JS自动补全的文法作为例子吧，虽然它并不一定完美，但真的很好用。</p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="peg"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="peg"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">js_line &nbsp; &nbsp;  &lt;- {| js_expr !. / js_expr_nonstart |}</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">js_expr_nonstart &lt;- ([^a-zA-Z0-9_$] js_expr / . js_expr_nonstart) !. / . js_expr_nonstart</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">js_expr &nbsp; &nbsp;  &lt;- ((jq_selector / prev_token) '.' / '') {:part: %a* :}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">jq_selector  &lt;- {:symbol: '$' balanced -&gt; 'jQuery.fn' :} func*</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">func &nbsp; &nbsp; &nbsp; &nbsp; &lt;- '.' %a+ balanced</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">prev_token &nbsp; &lt;- {:symbol: [a-zA-Z0-9_$/'"`]+ :} balanced?</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">balanced &nbsp; &nbsp; &lt;- '(' ([^()] / balanced)* ')'</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 161px;"></div><div class="CodeMirror-gutters" style="display: none; height: 161px;"></div></div></div></pre><p>简单解释一下这个文法是做什么的。这个文法的作用就是匹配出一个symbol.part的形式。由于jQuery是一个函数接一个函数的风格，而返回值基本上都是jQuery.fn，如果只匹配前一个符号的话是看不出来是不是jQuery的，所以要一致从jQuery的标志（也就是$符号）开始匹配。我们看到<code>jq_selector</code>这个规则就是干这个的，它会匹配<code>$(...).fn1(...).fn2(...).part</code>的形式；而<code>prev_token</code>这种匹配的就是简单的<code>symbol.part</code>或者<code>symbol(...).part</code>的形式。从而按照需要进行代码补全。<code>balanced</code>这条规则就是PEG用来匹配成对括号的示例代码，非常好用，当然Lua自带的模式匹配也支持成对括号匹配，但真的太弱了，成对括号无法增加?或者是*这种操作，这直接阻挡了我用Lua原生匹配完成这个匹配。</p><p>由于我们是从一行的第一个字符开始匹配的，但如果我们代码补全真正想要的永远是刚好匹配到最后一个字符，所以在<code>js_line</code>和<code>js_expr_nonstart</code>做了处理，如果匹配完发现不是最后一个字符，那就要错一位再尝试。其实思路是很直接的。这个匹配的完成也让我对PEG信心满满。我前段时间甚至还产生了解析SQL的想法，而且还真的去做了。只花了两三天时间就把SQL的主要功能实现了解析，还写了自己的AST输出函数，因为我觉得用现成的inspect输出太影响理解了，而且占用空间也太多。影响人类阅读。</p><p>对于一个简单的SQL：</p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="sql"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">SELECT</span> <span class="cm-keyword">DISTINCT</span> a, b <span class="cm-keyword">FROM</span> c <span class="cm-keyword">JOIN</span> d <span class="cm-keyword">ON</span> c<span class="cm-variable-2">.id</span> = d<span class="cm-variable-2">.id</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">WHERE</span> todo <span class="cm-keyword">IN</span>(<span class="cm-number">1</span>,<span class="cm-number">2</span>,<span class="cm-number">3</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">ORDER</span> <span class="cm-keyword">BY</span> b <span class="cm-keyword">ASC</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 69px;"></div><div class="CodeMirror-gutters" style="display: none; height: 69px;"></div></div></div></pre><p>输出的样子就像下面这样</p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="sql" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{sql_select:</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">SELECT</span>, <span class="cm-keyword">DISTINCT</span>, </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {select_elements:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {select_expr:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {expr:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {condition:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {operand:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {column_expr: a}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {select_expr:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {expr:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {condition:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {operand:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {column_expr: b}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">FROM</span>, </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {table_ref:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {table_factor:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {table_name: c}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {join_expr:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">JOIN</span>, </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {table_factor:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {table_name: d}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">ON</span>, </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {expr:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {condition:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {operand:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {column_expr: c<span class="cm-variable-2">.id</span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  =, </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {operand:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {column_expr: d<span class="cm-variable-2">.id</span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">WHERE</span>, </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {expr:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {condition:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {operand:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {column_expr: todo}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">IN</span>, </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {value: <span class="cm-number">1</span>},</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {value: <span class="cm-number">2</span>},</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {value: <span class="cm-number">3</span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">ORDER</span> <span class="cm-keyword">BY</span>, </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {order:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {column_expr: b},</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">ASC</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1656px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1656px;"></div></div></div></pre><p>你可以想象这样的结构是怎样用LPeg匹配出来的吗？其实简单来说就是反复运用简单匹配<code>{ p }</code>和table匹配<code>{| p |}</code>，这其实已经足够强大了。因为我们需要有tag，所以最多再加上一个命名匹配<code>{:name: p :}</code>。我想我一定不会去写一个巨型的正则表达式去匹配这个，当然，也没人去这么做。一般解析文法都会用专门的工具了，比如bison。当然徒手写也是一个办法，但怎么说呢，有这样一个形式文法支撑你，会比较放心，而且可读性也好。徒手写的解析器你绝对免不了看到一个或者多个长长的switch语句的。在这一点上，我确实非常佩服发明自动机的人。LPeg的背后就是一个自动机，只要把我的模式编译一下，就可以一直用它去匹配。</p><p>用LPeg创造解析器是可以词法分析和语法分析一体的。这一点我用了一阵之后才发现。我用LPeg分析SQL其实有参考其他好几个实现的。其中一个就是<a href='https://github.com/tclh123/lpeg-sql'>tclh123/lpeg-sql</a>，我觉得是非常有参考价值的。但他的文法没有考虑太多情况。我想用他的文法可能只能匹配极为简单的SQL吧。由于我有一个更大的目标，打算利用SQL解析去做些什么，所以我用我的文法测试了目前公司项目中实际的SQL，保证了它们都能通过我的解析，而不是匹配到一半就匹配不上了。</p><p>就像我前面说的那样，你在写一个PEG文法的时候，你就会留意优先级的问题。然后按照优先的顺序排列一条规则。比如，函数的优先级一定是比<code>column_expr</code>要高的。因为不管是<code>column_expr</code>还是<code>table_factor</code>，它们的后面有一个可有可无的<code>alias</code>，而PEG里一旦认为匹配成功了，就完全不会考虑下一个选项是什么，但也许，遇到的是一组括号，也就是我们的函数，但为时已晚，匹配失败。还有就是，如果你不限定规则，保留字与<code>name</code>之间是会有很多情况会匹配错的。因为如果你没有保留字的规定，那么<code>name</code>本本身是完全可以有保留字构成的，从字符组成上来看。还好PEG里面可以用<strong>否定断言</strong>，我刚才还在想如果在正则里，要叫做<strong>前向否定预判</strong>呢。通过下面一条规则</p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="peg"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="peg"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">name &lt;- !reserved ([0-9a-zA-Z$_]+ / ["`] [^"`]+ ["`])</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p>就搞定了。我曾经设想过如果没有这个，我可能要用到有序选择，而且还需要重写一些规则，才能保证name取不到标识符。但还好有这个“高级”算符。由于我看其他参考里联表<code>JOIN</code>的文法都写得不太好，我就参考了MySQL官方文档里的文法，但就是在这里我第一次遇到了传说中的<strong>左递归</strong>。我摘录一下我略微简化过的官方定义的文法，这很明显是一个CFG：</p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="sql" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">table_references:</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  table_reference [, table_reference] ...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">table_reference:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  table_factor</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  | joined_table</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">table_factor:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  tbl_name [PARTITION (partition_names)]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  [[<span class="cm-keyword">AS</span>] alias] [index_hint_list]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  | table_subquery [<span class="cm-keyword">AS</span>] alias [(col_list)]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  | ( table_references )</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">joined_table:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  table_reference {[INNER | CROSS] <span class="cm-keyword">JOIN</span> | STRAIGHT_JOIN} table_factor [join_specification]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  | table_reference {LEFT|RIGHT} [OUTER] <span class="cm-keyword">JOIN</span> table_reference join_specification</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  | table_reference NATURAL [INNER | {LEFT|RIGHT} [OUTER]] <span class="cm-keyword">JOIN</span> table_factor</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">join_specification:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">ON</span> search_condition</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  | USING (join_column_list)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 506px;"></div><div class="CodeMirror-gutters" style="display: none; height: 506px;"></div></div></div></pre><p>我当时对左递归不太了解，所以直接翻译成了PEG，结果如大家所料，LPeg报错了。于是乖乖去翻了半天博客和论文。大家可以发现上面的文法涉及的就是那种不好转化的<code>joined_table</code>的间接左递归，我们来看一下这个是为什么有左递归</p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang=""><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">joined_table &lt;- table_reference ... &lt;- joined_table ...</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p>我的解决办法就是不用<code>joined_table</code>这条规则，如果不搞掉这条规则可能会很难消掉这个左递归。不过我们需要理解这样的文法是想表达什么，因为我们有SQL的经验，我们知道这其实就是一个table可以连续<code>JOIN</code>好几个table，所以我修改了<code>table_ref</code>的定义，这个定义没有递归，直接就是前面提到的“盲目”贪婪匹配，一次性贪婪地把后面所有的<code>join_expr</code>都匹配上了，很简洁。</p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="sql"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">table_refs &nbsp; &lt;- table_ref (%s* <span class="cm-string">','</span> %s* table_ref)*</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">table_ref &nbsp;  &lt;- table_factor (%s+ join_expr)*</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">table_factor &lt;- (table_name / subquery) (%s+ (<span class="cm-keyword">AS</span> %s+)<span class="cm-variable-3">? </span>alias)<span class="cm-variable-3">? </span>/ <span class="cm-string">'('</span> %s* table_refs %s* <span class="cm-string">')'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">join_expr &nbsp;  &lt;- (( (LEFT / RIGHT) (%s+ OUTER)<span class="cm-variable-3">? </span>/ INNER / CROSS / NATURAL) %s+)<span class="cm-variable-3">?</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">JOIN</span> %s+ table_factor (%s+ join_spec)<span class="cm-variable-3">? </span>|}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">join_spec &nbsp;  &lt;- <span class="cm-keyword">ON</span> %s+ expr / USING %s* <span class="cm-string">'('</span> %s* name (%s* <span class="cm-string">','</span> %s* name)* %s* <span class="cm-string">')'</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 161px;"></div><div class="CodeMirror-gutters" style="display: none; height: 161px;"></div></div></div></pre><p>我写这篇博客的一个原因是，我看到关于PEG的中文资料非常少，英文资料也不算多。我很希望我这篇实践能给大家帮助，让大家尝试一下PEG这种文法。大家或许知道，2019年7月2日，Cloudflare因为正则表达式导致其服务中一个关键组件的CPU使用率大幅上升，出现了一次全球宕机。下面就是Cloudflare写的正则，它会导致<strong>灾难性回溯</strong>（catastrophic backtracking）。<sup class='md-footnote'><a href='#dfref-footnote-2' name='ref-footnote-2'>2</a></sup></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="regex"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="regex"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">(?:(?:\"|'|\]|\}|\\|\d|(?:nan|infinity|true|false|null|undefined|symbol|math)|\`|\-|\+)+[)]*;?((?:\s|-|~|!|{}|\|\||\+)*.*(?:.*=.*)))</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><p>正则表达式确实不好读懂对吧。至少对于复杂的pattern是这样的。不光不好读懂，还不好调试。就像rosie-lang的网页上说的，如果把它转化成PEG文法的话，便不会有这样的问题。<a href="../" title="返回首页">∎</a></p><div class='footnotes-area'  ><hr/>
<div class='footnote-line'><span class='md-fn-count'>1</span> What is Pattern Matching? - Definition from Techopedia, <a href='https://www.techopedia.com/definition/8801/pattern-matching' target='_blank' class='url'>https://www.techopedia.com/definition/8801/pattern-matching</a><a name='dfref-footnote-1' href='#ref-footnote-1' title='回到文档' class='reversefootnote' >↩</a></div>
<div class='footnote-line'><span class='md-fn-count'>2</span> Practical PEGs, <a href='https://rosie-lang.org/blog/2019/07/18/practicalpegs.html' target='_blank' class='url'>https://rosie-lang.org/blog/2019/07/18/practicalpegs.html</a><a name='dfref-footnote-2' href='#ref-footnote-2' title='回到文档' class='reversefootnote' >↩</a></div></div></div>
<script src="../dist/style_fix.js"></script>
<script src="../dist/mini_pangu.js"></script>
</body>
</html>
