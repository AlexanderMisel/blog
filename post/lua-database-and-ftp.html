<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
<title>lua-database-and-ftp</title><link href="../css/han.css" rel="stylesheet">
</head>
<body class='typora-export os-windows' >
<div  id='write'  class = 'is-node'><h1><a name="lua连接数据库与ftp" class="md-header-anchor"></a><span>Lua连接数据库与FTP</span></h1><p><span>在使用Lua以来，我一直想解决的一个问题就是连接数据库。而最近，我终于能够通过Lua连上MySQL数据库了。所以想给大家分享一下。另外我还想说一下Lua连FTP的内容。说实话二者没什么联系，主要是因为我最近做了一个既用得上数据库，又用得上FTP的小任务。</span></p><h2><a name="lua连数据库" class="md-header-anchor"></a><span>Lua连数据库</span></h2><p><span>我会主要说一下连接MySQL数据库。MySQL在开源关系型数据库里算是最流行的一个了。我司也在使用MySQL。所以连接MySQL也是我的重要需要之一。如果没有数据库连接能力，Lua确实也可以开发Web服务，以及一些有用的功能，但如果没有数据库连接能力的话，可能即便能操作数据，也无法入库，只能在内存里存着，或者用自己的方式存文件。解析起来没有数据库容易，数据量大了的话，也会很慢。</span></p><p><span>SQL有自己处理磁盘上数据的方式。能够用它成熟的策略去磁盘中读取数据。SQL还有自己的处理数据的方式。对于处理数据来说，SQL语言显得非常便捷，虽然也有表达能力不如编程语言的问题。但如果我们用编程语言调用SQL的话，就可以在编程语言中弥补这部分问题了。</span></p><p><span>好啦，不多说废话了。搜遍互联网，就会发现这方面的资料真的是很少。而且几乎都指向LuaSQL这个库。如果说还有别的话，大概就是LuaDBI这个库（我最近才发现还有这个库）。首先，其实如果能花时间了解</span><a href='https://dev.mysql.com/doc/internals/en/client-server-protocol.html'><span>MySQL的协议</span></a><span>的话，是一定能手写一个连接库的。在OpenResty的生态里，连接MySQL有一个库，叫做</span><a href='https://github.com/openresty/lua-resty-mysql'><span>lua-resty-mysql</span></a><span>，是OpenResty的创造者章亦春手写的。能够明显看出他的意图，就是按我上面说的那样，直接按照MySQL的协议与MySQL通信，而不是在一个现成库基础上调用它的库函数的。</span></p><p><span>我一开始其实也有改造一下他这个库的想法。毕竟我搂了一眼，发现它除了依赖ngx的socket模块不让我喜欢以外，其他的部分其实都还好。它使用ngx模块的想法我也能理解。因为这是OpenResty的特色之一，用nginx的socket来弥补。但我不想对nginx依赖太多。另外一方面考虑是手写的这个库可能没有实现MySQL的一些功能，只是基本的连接和使用。但是其他的一些库，又找不到二进制，我自己尝试编译也没成功。所以长期以来，我都没解决Lua连库的问题。</span></p><p><span>不过，我最近关注到一个Lua发行版，叫做</span><a href='https://luapower.com/'><span>luapower</span></a><span>，它和ulua一样，都是基于LuaJIT的，而且是MinGW编译的。二进制下载就可以用。luapower自带的MySQL连接库很是全面，它是使用FFI调用MySQL或者MariaDB的dll来访问MySQL的，实现的功能比较全面。如果我日后用到什么功能，也不用担心还没有实现了。</span></p><p><span>相比LuaSQL，我觉得它的文档是相当全的。我在了解到luapower的MySQL连接库以后，轻松地就连上了MySQL数据库。不过值得注意地一点是，如果用libmariadb这个库的话，需要把zlib这个库也安装上，以为有依赖关系。</span></p><p><span>在MySQL之外，可能大家用的比较多的数据库是PostgreSQL。我知道有人想说是Oracle。用Oracle的话，可能你真的需要编译一下LuaSQL了。如果你的Oracle就是一个中间库的话，你又想用脚本连的话，或许可以考虑用python连。因为Oracle官方提供了一个叫做cx_Oracle的python库，用它连肯定顺手啊。还是说回PostgreSQL。我个人感觉</span><a href='https://github.com/leafo/pgmoon'><span>pgmoon</span></a><span>这个库就不错。一个原因是leafo这个人做了很多lua的周边库，他还创造了MoonScript语言，以及一个我看着还不错的Web框架Lapis。另一个原因是</span><a href='https://leafo.net/guides/using-postgres-with-openresty.html'><span>这篇文章</span></a><span>提到的它跟其他同类库的对比，说得还挺有道理的。</span></p><p><span>这里我就不上代码了。因为我现在也就是在用几个基本的函数执行简单的查询。怎么调一查文档全知道。</span></p><h2><a name="lua连ftp" class="md-header-anchor"></a><span>Lua连FTP</span></h2><p><span>连接FTP本身就是LuaSocket的一个功能。不过LuaSocket的文档有点简略，所以如果想用FTP的各种命令，而不局限于GET和PUT的话，就得阅读一下ftp.lua的源码了。官方文档了也提到，使用底层接口，用户可以轻松创建自己的函数来访问FTP协议支持的任何操作。那就让我们来看看我做了些什么吧。我先放代码</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="lua" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="lua"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><span><span>​</span>x</span></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span class="cm-variable">socket</span> = <span class="cm-builtin">require</span>(<span class="cm-string">'socket'</span>)</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span class="cm-variable">ftp</span> &nbsp;  = <span class="cm-builtin">require</span>(<span class="cm-string">'socket.ftp'</span>)</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span class="cm-variable">ltn12</span>  = <span class="cm-builtin">require</span>(<span class="cm-string">'ltn12'</span>)</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span class="cm-variable">url</span> &nbsp;  = <span class="cm-builtin">require</span>(<span class="cm-string">'socket.url'</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">open_ftp</span> = <span class="cm-variable">socket.protect</span>(<span class="cm-keyword">function</span>(<span class="cm-variable">host</span>, <span class="cm-variable">user</span>, <span class="cm-variable">pwd</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">f</span> = <span class="cm-variable">ftp.open</span>(<span class="cm-variable">host</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">f</span>:<span class="cm-variable">greet</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">f</span>:<span class="cm-variable">login</span>(<span class="cm-variable">user</span>, <span class="cm-variable">pwd</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">f</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">end</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">scan_folder</span> = <span class="cm-variable">socket.protect</span>(<span class="cm-keyword">function</span> (<span class="cm-variable">f</span>, <span class="cm-variable">u</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">t</span> = {}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">gett</span> = <span class="cm-variable">url.parse</span>(<span class="cm-variable">u</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">gett.command</span> = <span class="cm-string">'nlst'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">gett.sink</span> = <span class="cm-variable">ltn12.sink.table</span>(<span class="cm-variable">t</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">f</span>:<span class="cm-variable">pasv</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">f</span>:<span class="cm-variable">receive</span>(<span class="cm-variable">gett</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">return</span> <span class="cm-builtin">table.concat</span>(<span class="cm-variable">t</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">end</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">retrieve</span> = <span class="cm-variable">socket.protect</span>(<span class="cm-keyword">function</span>(<span class="cm-variable">f</span>, <span class="cm-variable">u</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">t</span> = {}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">gett</span> = <span class="cm-variable">url.parse</span>(<span class="cm-variable">u</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">gett.sink</span> = <span class="cm-variable">ltn12.sink.table</span>(<span class="cm-variable">t</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">f</span>:<span class="cm-variable">pasv</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">f</span>:<span class="cm-variable">receive</span>(<span class="cm-variable">gett</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">return</span> <span class="cm-builtin">table.concat</span>(<span class="cm-variable">t</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">end</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span class="cm-variable">fhandle</span> = <span class="cm-variable">open_ftp</span>(<span class="cm-string">'xx.xx.xx.xx'</span>, <span class="cm-string">'alexmisel'</span>, <span class="cm-string">'password'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span class="cm-variable">the_files</span> = <span class="cm-variable">scan_folder</span>(<span class="cm-variable">fhandle</span>, <span class="cm-string">'ftp://xx.xx.xx.xx/abc/'</span>):<span class="cm-variable">split</span>(<span class="cm-string">'\r?\n'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> <span class="cm-variable">i</span>, <span class="cm-variable">v</span> <span class="cm-keyword">in</span> <span class="cm-builtin">ipairs</span>(<span class="cm-variable">the_files</span>) <span class="cm-keyword">do</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">file_str</span> = <span class="cm-variable">retrieve</span>(<span class="cm-variable">fhandle</span>, <span class="cm-string">'ftp://xx.xx.xx.xx/abc/'</span> .. <span class="cm-variable">v</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">f</span> = <span class="cm-builtin">io.open</span>(<span class="cm-variable">v</span>, <span class="cm-string">'wb'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">f</span>:<span class="cm-builtin">write</span>(<span class="cm-variable">csv_str</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">f</span>:<span class="cm-builtin">close</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">end</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 819px;"></div><div class="CodeMirror-gutters" style="display: none; height: 819px;"></div></div></div></pre><p><span>以上代码我重新实现了打开FTP连接、扫描目录中的文件以及获取文件。并在下面调用这三个函数，实现了基本的连接FTP，获取某个目录的文件，并且下载里面的所有文件。我为什么没有用库里的那个GET呢？因为我觉得它每次不管干什么都重新open、greet、login实在是太没必要了，而且我看人家别的语言或者客户端连接FTP，似乎是可以保持连接的。虽然就几行代码，但我确实遇到了一些坑，这里跟大家分享一下子。</span></p><p><span>第一个我要分享的地方就是</span><code>PASV</code><span>这个命令，或者说是FTP的传输模式。首先说坑在哪儿。就是你不管receive什么东西，都需要先发一个</span><code>PASV</code><span>命令。我第一开始封装login函数的时候，把</span><code>PASV</code><span>给封进去了。</span></p><p><span>第二个关于</span><code>socket.protect</code><span>的。我们用底层函数重新封的函数最好都要加这个。我最近就遇到这里面函数报错，直接导致LuaJIT程序崩溃。主要这种错误用Lua本身的</span><code>pcall</code><span>还挡不住，所以还是得用LuaSocket自带的</span><code>socket.protect</code><span>，这样还可以把真正的错误传给第二个返回值（第一个为</span><code>nil</code><span>）。</span></p><p><span>第三个是编码的事。因为我接触的FTP就是用微软的FTP搭的，所以编码是GBK的。我把文件下载到Windows刚好也是GBK编码的，所以文件名不会出现乱码。不过如果是Linux的话，或许需要转码。</span></p><p><span>不过说到字符集转换，使用最广泛的就是iconv库了。不过这个库也是经常让我很折腾。由于我是在Windows下开发，所以只要Windows没解决，那就是没解决问题。找了许久终于找到了FFI的解决方案，那就是</span><a href='https://github.com/semyon422/aqua'><span>aqua</span></a><span>这个看起来不知名连README都没有的工程里的iconv.lua。说实话我以前是编译过iconv的，所以实在不行的话，我可能会去编译LuaJIT版的</span><a href='https://ittner.github.io/lua-iconv/'><span>lua-iconv</span></a><span>（因为luapower实在太香了），毕竟我以前成功编译过Lua 5.1版的。</span></p><p><span>或许还有第四个坑，我发现我自己上传文件到FTP上，但并没有重现这个问题。但是我在实际使用的时候发现文件已经增加了，但是我的扫描却没有扫到的问题。我的解决方案就是在每次</span><code>scan_folder</code><span>之前重新登录一次，就像原本的实现那样。</span></p><hr /><p><span>总而言之，通过以上技术，我能够顺利地访问操作数据库，以及FTP。FTP的上传函数我没有写，但如果大家需要，可以参考库本身自带的</span><code>put</code><span>函数进行修改。再次重申，本文所有Lua库的选择已经站在LuaJIT的角度上。用过Lua的应该都清楚，LuaJIT的FFI模块是不受原生Lua支持的，所以使用原生的同学请不要照搬。</span><a href='../' title='返回首页'><span>∎</span></a></p></div>
<script src="../dist/mini_pangu.js"></script>
</body>
</html>