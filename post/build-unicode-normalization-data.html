<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
<title>build-unicode-normalization-data</title><link href="../css/han.css" rel="stylesheet">
</head>
<body class='typora-export'>
<div id='write'  class=''><h1><a name="构建unicode归一化数据" class="md-header-anchor"></a><span>构建Unicode归一化数据</span></h1><p><span>什么是Unicode归一化数据呢？顾名思义，就是把Unicode进行归一化，以方便统一地进行处理。我之所以着手做这项工作，一个重要原因是我看到了前人在这方面做过的努力，我希望做一份实用性更强，并且兼顾可读性的归一化数据。</span></p><p><span>在这份数据中，我采用“字形”作为依据来进行归一化，这一点恰好契合了一篇Unicode技术标准的要求，也就是《</span><a href='http://www.unicode.org/reports/tr39/'><span>tr39：Unicode安全机制</span></a><span>》一文。该文提到了一种“骨架算法”（Skeleton algorithm），用于比较两个Unicode字符是否为形近字。在该算法的解释中提到两次运用NFD来拆解Unicode。NFD是Normalization Form Canonical Decomposition的缩写，是一个Unicode归一化的标准，用来将一个字拆解为组成这个字的各个</span><strong><span>基础部分</span></strong><span>。</span><sup class='md-footnote'><a href='#dfref-footnote-1' name='ref-footnote-1'>1</a></sup><span> 在骨架算法中还用到了Unicode形近字（confusables）库，这个我后面也会用到。但我在第一步没有了解到这一点。</span></p><p><span>那么构建这样一份数据的意义何在呢？我根据我个人的想法总结以下几点供大家参考：</span></p><ol><li><span>破开伪装（antispoof）。在网站用户注册方面，破坏者可能会注册与正常用户形近的用户。维基百科的用户注册就加了这方面限制，与其他用户名的Unicode形近的用户名，直接禁止注册。</span></li><li><span>内容审查。在开放编辑的百科（如维基百科），以及论坛、聊天群组中，常常需要对特定的词汇进行控制。然而就会有一些用户使用Unicode意义上的形近字避开审查。当然如果想要更强，可以结合</span><a href='https://github.com/cjkvi/cjkvi-ids'><span>IDS数据</span></a><span>，或是</span><a href='https://unicode.org/charts/unihan.html'><span>Unihan数据</span></a><span>的读音，来把更广泛的相似的字也囊括在内。</span></li><li><span>简化代码。在字符串匹配中，如果我们想同时匹配简繁体，或者形近字也匹配上，往往会在正则表达式里面用class语法，比如</span><code>[电電]影</code><span>。但在使用归一化数据处理一遍文字之后，可以避免这样的语法。</span></li></ol><p><span>下面就让我来说一下我具体是怎样构建数据的。虽然构建完数据，其实就是一个简单的对应表，但想要基于其他数据集，构建一个符合我们预期的归一化数据，还是需要一套合适的流程的。那么我就介绍一下。</span></p><h2><a name="初版ccnorm" class="md-header-anchor"></a><span>初版：ccnorm</span></h2><p><span>有了想法之后，我就在网上查找相关的数据。维基百科的</span><strong><span>防滥用过滤器</span></strong><span>（Abuse Filter）中的ccnorm函数是我首先想到的。因为我们维基百科的开放性，破坏者层出不穷。全自动的过滤器的存在大大减轻了我们人工巡查的工作，在用户提交编辑的时候，先进过滤器，如果过滤器通不过，就根本不会提交到正式的条目历史中去。</span></p><p><span>ccnorm正是过滤器语法提供给我们使用的一个函数，效果就像下面这样</span></p><pre lang="" class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre>x</pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">ccnorm("w1k1p3d14") =&gt; "WIKIPEDIA"</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">ccnorm("ωɨƙɩᑭƐƉ1α") =&gt; "WIKIPEDIA"</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><p><span>阅读代码，我发现这个函数引用的是另一个库的数据，叫做</span><a href='https://github.com/wikimedia/Equivset'><span>Equivset</span></a><span>。Equivset从字面就能看出来，equivalent set嘛。也是WMF官方的一个库。采用PHP将原始数据处理成更方便使用的格式。基金会似乎真的是偏好PHP。一个完全没有必要用到PHP的地方都要秀一下PHP。</span></p><p><span>这个库正是我想要的，它会把拉丁文的A和希腊文的A画等号。还会把美元符号$和拉丁文S等价。但我没想到它不止于此。打开它的原始数据，我发现这样的描述：</span></p><blockquote><p><span>我们试图包括以下类型的对等:</span></p><ul><li><span>大小写合并。虽然不同字母的字母在视觉上是不同的，但是熟悉字母表的人很容易把它们搞混。两个大小写不同的单词可以理解为同一个单词。这是一种流行的假冒其他用户的方法。</span></li><li><span>视觉上相似的字符。跨字母系统的字符对也包括在内，但是这些字符对往往会在文字系统中产生错误的合并，因此应该避免。本软件实现了对跨字母系统的字符串的一揽子限制，这使得跨字母系统的字符对大部分是多余的。</span></li><li><span>中文简繁体对应.</span></li></ul><p><span>本列表是基于尼尔·哈里斯制作的一个列表，那个列表是通过未知的方法得出的。该列表还包含音译对，我们认为这些对过多，并试图删除。例如，拉丁字母E和H被认为是等价的，因为西里尔字母“Н”（看起来像拉丁语H）的拉丁音译是“E”。</span></p></blockquote><p><span>起初我认为它的中文字符只是简繁体对应，但我发现并非如此，它会还会把形近的字归在一起，正如我们前面提到的Unicode confusable干的事那样。但正如这个描述，这是Neil Harris通过不知什么办法搞出来的，但经过我认真的检查，发现确实准确性较高。连一些古汉语通假字都认为是等价的，这让我感觉很不可思议。经过调查，这个Neil Harris是一个活跃在Unicode邮件列表的人，我觉得比较可信，所以我会把这份数据作为基础，来构建我自己的ccnorm数据。</span></p><p><span>事实上我之所以不直接用这份现成的ccnorm，而再次处理的原因之一是，这份列表关于中文简繁体的部分有时会归到繁体，甚至异体字上面。虽然Unicode tr39提到，skeleton算法关注的是把形近字归一化，并不会考虑归一化后的可读性。但我希望，我构建的数据集是关注这一点的，而且是以简体中文为中心的。所以我的第一想法就是把我之前用过的简繁转换对应表找过来。大概就是这样：</span></p><pre lang="lua" class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="lua"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre>x</pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span class="cm-variable">simp</span> = <span class="cm-string">'万与丑专业丛东丝丢两严丧个丬丰临'</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span class="cm-variable">trad</span> = <span class="cm-string">'萬與醜專業叢東絲丟兩嚴喪個爿豐臨'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span class="cm-variable">t2s</span> = {}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> <span class="cm-variable">s</span>, <span class="cm-variable">v</span>, <span class="cm-variable">e</span> <span class="cm-keyword">in</span> <span class="cm-variable">trad</span>:<span class="cm-variable">gmatch</span>(<span class="cm-string">'()([%z\1-\127\194-\244][\128-\191]*)()'</span>) <span class="cm-keyword">do</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">t2s</span>[<span class="cm-variable">v</span>] = <span class="cm-variable">simp</span>:<span class="cm-variable">sub</span>(<span class="cm-variable">s</span>, <span class="cm-variable">e-1</span>)</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">end</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 138px;"></div><div class="CodeMirror-gutters" style="display: none; height: 138px;"></div></div></div></pre><p><span>这套转换是网上广为流传的。也不知道是谁整理的，很早以前就有。有了这个对应表之后，对于不符合这个规则的，调一下顺序就好。但是这个简繁转换的库实在是不全。而且如果同一组里找错了转换的对象，会对后面可读性造成影响。不过出来的结果还算满意，只不过总是要因为有些字符没有找到合适的转换，而无法进行正确的交换。为此，我增加了更强大的OpenCC单字转换库。OpenCC是最流行的开源简繁转换库，它的数据也确实很好用，有了它的数据，我几乎不需要手工再去补充简繁数据了。但异体字依然有一定数量。</span></p><p><span>我终于意识到或许有更简便的算法。我直接拿国标的字去每一组候选字里找不就完了吗，费劲找繁简对应干什么。那么国标的汉字列表去哪里找呢？我先搜索了GB2312，然后从一个维基百科的链接里找到了</span><strong><span>通用规范汉字表</span></strong><span>这个名词，于是在维基文库的原始文档里找到了整个列表。与其自己去wikitext里面取出来处理，不如找GitHub上别人处理好的。一开始我找到了</span><a href='https://github.com/lunatao/chinese_character'><span>chinese_character</span></a><span>这个项目，然后成功的写出了改版后的ccnorm。效果好多了，好到我可以去QQ群通知大家帮我测试了。</span></p><h2><a name="增强版eccnorm" class="md-header-anchor"></a><span>增强版：eccnorm</span></h2><p><span>也许读到上面你会以为我已经完成了，其实我当时也确实觉得差不多了。可是我发现我忽略了什么。没错，有些汉字即便是在规范汉字表中，也是出现多个。这让我想起了我看到通用汉字表的时候，好像分了一级、二级、三级的。于是我再回GitHub，找到</span><a href='https://github.com/shengdoushi/common-standard-chinese-characters-table'><span>common-standard-chinese-characters-table</span></a><span>这个项目，里面有分好级的数据。于是代码重新写过，成为了下面这样子：</span></p><pre lang="lua" class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="lua"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre>x</pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> <span class="cm-variable">line</span> <span class="cm-keyword">in</span> <span class="cm-builtin">io.lines</span>(<span class="cm-string">'equivset.txt'</span>) <span class="cm-keyword">do</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">equiv</span> = <span class="cm-variable">line</span>:<span class="cm-variable">split</span>(<span class="cm-string">' '</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">swapped</span> = <span class="cm-keyword">false</span></span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment">-- in tgscc level 1</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">for</span> <span class="cm-variable">i</span>, <span class="cm-variable">v</span> <span class="cm-keyword">in</span> <span class="cm-builtin">ipairs</span>(<span class="cm-variable">equiv</span>) <span class="cm-keyword">do</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">std_level1</span>[<span class="cm-variable">v</span>] <span class="cm-keyword">then</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">equiv</span>[<span class="cm-number">1</span>], <span class="cm-variable">equiv</span>[<span class="cm-variable">i</span>] = <span class="cm-variable">v</span>, <span class="cm-variable">equiv</span>[<span class="cm-number">1</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">swapped</span> = <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-keyword">break</span></span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">end</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">end</span></span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment">-- in tgscc level 2 (省略代码)</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  ...</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment">-- in tgscc level 3 (省略代码)</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  ...</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment">-- 对于没有swap过的组合，再用OpenCC的简繁转换库刷一遍</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">if</span> <span class="cm-keyword">not</span> <span class="cm-variable">swapped</span> <span class="cm-keyword">then</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">dict_simp</span> = <span class="cm-variable">cc_t2s</span>[<span class="cm-variable">equiv</span>[<span class="cm-number">1</span>]] <span class="cm-keyword">or</span> <span class="cm-variable">cc_t2s</span>[<span class="cm-variable">equiv</span>[<span class="cm-number">2</span>]] <span class="cm-keyword">or</span> <span class="cm-variable">cc_t2s</span>[<span class="cm-variable">equiv</span>[<span class="cm-number">3</span>]] <span class="cm-keyword">or</span> <span class="cm-variable">cc_t2s</span>[<span class="cm-variable">equiv</span>[<span class="cm-number">4</span>]] <span class="cm-keyword">or</span> <span class="cm-variable">cc_t2s</span>[<span class="cm-variable">equiv</span>[<span class="cm-number">5</span>]] <span class="cm-keyword">or</span> <span class="cm-variable">cc_t2s</span>[<span class="cm-variable">equiv</span>[<span class="cm-number">6</span>]] <span class="cm-keyword">or</span> <span class="cm-variable">cc_t2s</span>[<span class="cm-variable">equiv</span>[<span class="cm-number">7</span>]] <span class="cm-keyword">or</span> <span class="cm-variable">cc_t2s</span>[<span class="cm-variable">equiv</span>[<span class="cm-number">8</span>]] <span class="cm-keyword">or</span> <span class="cm-variable">cc_t2s</span>[<span class="cm-variable">equiv</span>[<span class="cm-number">9</span>]]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">dict_simp</span> <span class="cm-keyword">then</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span> <span class="cm-variable">i</span> = <span class="cm-number">2</span>, #<span class="cm-variable">equiv</span> <span class="cm-keyword">do</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">dict_simp</span> == <span class="cm-variable">equiv</span>[<span class="cm-variable">i</span>] <span class="cm-keyword">then</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">equiv</span>[<span class="cm-number">1</span>], <span class="cm-variable">equiv</span>[<span class="cm-variable">i</span>] = <span class="cm-variable">dict_simp</span>, <span class="cm-variable">equiv</span>[<span class="cm-number">1</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">break</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">end</span></span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">end</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">for</span> <span class="cm-variable">i</span> = <span class="cm-number">2</span>, #<span class="cm-variable">equiv</span> <span class="cm-keyword">do</span></span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">equivset</span>[<span class="cm-variable">equiv</span>[<span class="cm-variable">i</span>]] = <span class="cm-variable">equiv</span>[<span class="cm-number">1</span>]</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">end</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  ...</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">end</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 851px;"></div><div class="CodeMirror-gutters" style="display: none; height: 851px;"></div></div></div></pre><p><span>你或许看出了我的意图。经过精细处理的归一化库甚至可以作为简繁转换库来使用。虽然有合并到其他汉字的可能，但一定是简体字，而且是比这个字更常用的字。所以一般不会出错。因为常用的字永远是优先的。而我们日常接触到的文本中也大部分是常用字。</span></p><p><span>这就是ccnorm的最后一版。也是eccnorm的基础。要知道，群友永远有出不完的花样。果然没经过多久测试，就暴露出ccnorm的数据不足的问题了，这主要是因为我们一开始作为基础的Equivset在收集数据上是不足的缘故。据我猜测，Equivset的数据很多都是基于非官方人工收集，虽然已经足够好了，但是不够全。尤其表现在连NFD的映射表都不能囊括，还有就是Unicode官方提供的Confusables没有融入进来。</span></p><p><span>举个例子，Unicode有一个区域叫做康熙部首的，英文叫Kangxi radicals，存着一些和正常汉字长得一模一样的字，但是作为偏旁部首存在，所以独立占一个位置。比如这个字“⼼”，看着像“心”，但是你用程序去比，会发现不相等。下图是康熙字典里面汉字的部首分布，蛮有意思，所以给大家展示在这里。</span></p><p><img src="https://upload.wikimedia.org/wikipedia/commons/d/dd/Radicals_frequency_table.png" referrerpolicy="no-referrer" alt="Kangxi Radicals"></p><p><span>通过Confusables就可以了把这部分补上，而且Confusables里面还有大量其他语种的homoglyph的例子，如果融合了这部分，那我的数据集将会上一个新台阶。不过由于我认为会带来比较大的影响，所以重新起名eccnorm，意为extended ccnorm。</span></p><p><span>那么话不多说我们来看看实现细节。首先我们NFD数据用的是WMF的另一个库Scribunto的ustring里面的</span><a href='https://github.com/wikimedia/mediawiki-extensions-Scribunto/blob/master/includes/engines/LuaCommon/lualib/ustring/normalization-data.lua'><span>normalization-data.lua</span></a><span>。这个数据直接就是Lua的，实在没有再好用啦。另外我们还会用到之前生成ccnorm没有提到的normset，也就是一个从归一化后的文字逆向对应的表，形如下面这样</span></p><pre lang="lua" class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="lua"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre>x</pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">return</span> {</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>[<span class="cm-string">"殴"</span>] = { <span class="cm-string">"毆"</span> },</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>[<span class="cm-string">"殷"</span>] = { <span class="cm-string">"慇"</span> },</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>[<span class="cm-string">"毁"</span>] = { <span class="cm-string">"毀"</span>, <span class="cm-string">"譭"</span> },</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>[<span class="cm-string">"毂"</span>] = { <span class="cm-string">"軲"</span>, <span class="cm-string">"轂"</span>, <span class="cm-string">"轱"</span> },</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>[<span class="cm-string">"每"</span>] = { <span class="cm-string">"毎"</span> },</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>[<span class="cm-string">"毕"</span>] = { <span class="cm-string">"畢"</span>, <span class="cm-string">"罼"</span>, <span class="cm-string">"鏎"</span> }</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 184px;"></div><div class="CodeMirror-gutters" style="display: none; height: 184px;"></div></div></div></pre><p><span>处理Confusables的代码大致如下，</span><code>homo_pairs</code><span>即ccnorm：</span></p><pre lang="lua" class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="lua"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre>x</pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> <span class="cm-variable">a</span>, <span class="cm-variable">b</span> <span class="cm-keyword">in</span> <span class="cm-variable">confusables</span>:<span class="cm-variable">gmatch</span>(<span class="cm-string">'%( ([^ ]+) → ([^ ]+) %)'</span>) <span class="cm-keyword">do</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment">-- 首先读取原始字符 a 和归一化后的字符 b</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment">-- 注意排除掉LEFT-TO-RIGHT MARK，在从右向左写的文字里很常见</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">a</span> = <span class="cm-variable">a</span>:<span class="cm-variable">gsub</span>(<span class="cm-string">'\226\128\142'</span>, <span class="cm-string">''</span>)</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">b</span> = <span class="cm-variable">b</span>:<span class="cm-variable">gsub</span>(<span class="cm-string">'\226\128\142'</span>, <span class="cm-string">''</span>):<span class="cm-variable">gsub</span>(<span class="cm-string">'%('</span>, <span class="cm-string">''</span>):<span class="cm-variable">gsub</span>(<span class="cm-string">'%)'</span>, <span class="cm-string">''</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment">-- 排除掉我们想人工忽略的 a</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">ignore</span>[<span class="cm-variable">a</span>] <span class="cm-keyword">then</span> <span class="cm-variable">goto</span> <span class="cm-variable">continue</span> <span class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment">-- 当 a 和 b 都是单个 Unicode 的时候我们才会接受</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">a</span>:<span class="cm-variable">match</span>(<span class="cm-string">'^[%z\1-\127\194-\244][\128-\191]*$'</span>) <span class="cm-keyword">and</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">b</span>:<span class="cm-variable">match</span>(<span class="cm-string">'^[%z\1-\127\194-\244][\128-\191]*$'</span>) <span class="cm-keyword">then</span></span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">-- 如果 b 不是数字，且在 ccnorm 里面有，那么我们要让 a 归一化成 ccnorm(b)</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-keyword">not</span> <span class="cm-builtin">tonumber</span>(<span class="cm-variable">b</span>) <span class="cm-keyword">and</span> <span class="cm-variable">homo_pairs</span>[<span class="cm-variable">b</span>] <span class="cm-keyword">then</span></span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-comment">-- 为什么要排除 I 呢，因为不排除的话会有被刷成 L 的风险</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">a</span> ~= <span class="cm-string">'I'</span> <span class="cm-keyword">and</span> <span class="cm-variable">homo_pairs</span>[<span class="cm-variable">a</span>] ~= <span class="cm-string">'I'</span> <span class="cm-keyword">then</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">homo_pairs</span>[<span class="cm-variable">a</span>] = <span class="cm-variable">homo_pairs</span>[<span class="cm-variable">b</span>]</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-keyword">end</span></span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">-- 如果 b 是数字，则直接归一化为 b：因为群友反馈把数字归一化为字母太激进</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">elseif</span> <span class="cm-builtin">tonumber</span>(<span class="cm-variable">b</span>) <span class="cm-keyword">then</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">homo_pairs</span>[<span class="cm-variable">a</span>] = <span class="cm-variable">b</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">else</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-comment">-- 剩下就是 ccnorm 里面没有的情况了，我们要小心试探一下 ccnorm(a)</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-comment">-- 如果没有，那就看看 a 是不是已经是归一化的结果了，即检查 normset[a]</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-comment">-- 如果是，那么我们新的 norm 也是 a 就行了</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">norm</span> = <span class="cm-variable">homo_pairs</span>[<span class="cm-variable">a</span>] <span class="cm-keyword">or</span> (<span class="cm-variable">normset</span>[<span class="cm-variable">a</span>] <span class="cm-keyword">and</span> <span class="cm-variable">a</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">norm</span> <span class="cm-keyword">and</span> <span class="cm-variable">norm</span> ~= <span class="cm-variable">b</span> <span class="cm-keyword">then</span></span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">-- 对于是英文字母的，我们直接让 a 与 b 都归一化为 norm</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">norm</span>:<span class="cm-variable">match</span>(<span class="cm-string">'^[A-Z]$'</span>) <span class="cm-keyword">then</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">homo_pairs</span>[<span class="cm-variable">a</span>] = <span class="cm-variable">norm</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">homo_pairs</span>[<span class="cm-variable">b</span>] = <span class="cm-variable">norm</span></span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">-- 其他的要特殊处理：除了让 a 归一化为 b 以外，还要让所有原来 ccnorm(x) = a</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">-- 的 x 也都归一化到 b，并把 b 插入到 normset 中，避免后续出错</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">else</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">a_set</span> = <span class="cm-variable">normset</span>[<span class="cm-variable">norm</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span> <span class="cm-variable">_</span>, <span class="cm-variable">v</span> <span class="cm-keyword">in</span> <span class="cm-builtin">ipairs</span>(<span class="cm-variable">a_set</span>) <span class="cm-keyword">do</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">homo_pairs</span>[<span class="cm-variable">v</span>] = <span class="cm-variable">b</span></span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">end</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">normset</span>[<span class="cm-variable">b</span>] = <span class="cm-variable">a_set</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">homo_pairs</span>[<span class="cm-variable">a</span>] = <span class="cm-variable">b</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">end</span></span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-comment">-- 其余情况统统让 a 归一化到 b 即可</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-keyword">else</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">homo_pairs</span>[<span class="cm-variable">a</span>] = <span class="cm-variable">b</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">else</span></span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">-- print(b, b:byte(1, 15))</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  ::<span class="cm-variable">continue</span>::</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">end</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1173px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1173px;"></div></div></div></pre><p><span>从上面的代码中可以看出，我是更加信任Unicode Confusables的，给了它更高的优先级。但是它有个问题就是英文字母归一化没有Equivset更加全面，所以如果是英文字母的话我们进行了特殊操作。此外我还利用Confusables的数据把原来ccnorm的数字纠正了，一旦有Confusable的指向存在，直接忽略原来的ccnorm。</span></p><p><span>接下来就是NFD的事情了。从下面的代码可以看出，基本上就是最Unicode的范围做了一些排除，尤其是长得奇奇怪怪的那种。因为我要拿出它NFD后的第一个字符作为归一化的结果，如果不排除的话，很多附加符的混合也被归一化成单个附加符了，没有必要。所以直接抛弃他们比较方便。与Confusables对比，可以看出NFD的结果我给它的优先级比ccnorm低，一旦有ccnorm，那我就会避免采用NFD的结果。</span></p><pre lang="lua" class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="lua"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> <span class="cm-variable">k</span>, <span class="cm-variable">v</span> <span class="cm-keyword">in</span> <span class="cm-builtin">pairs</span>(<span class="cm-variable">norm_data.decomp</span>) <span class="cm-keyword">do</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">a</span> = <span class="cm-variable">utf8char</span>(<span class="cm-variable">k</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">b</span> = <span class="cm-variable">utf8char</span>(<span class="cm-variable">v</span>[<span class="cm-number">1</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">flag</span> = <span class="cm-keyword">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">k</span> &gt;= <span class="cm-number">0x0900</span> <span class="cm-keyword">and</span> <span class="cm-variable">k</span> &lt;= <span class="cm-number">0x09FF</span> <span class="cm-keyword">or</span> <span class="cm-variable">k</span> &gt;= <span class="cm-number">0x0B00</span> <span class="cm-keyword">and</span> <span class="cm-variable">k</span> &lt;= <span class="cm-number">0x0DFF</span> <span class="cm-keyword">or</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">k</span> &gt;= <span class="cm-number">0x0F00</span> <span class="cm-keyword">and</span> <span class="cm-variable">k</span> &lt;= <span class="cm-number">0x0FFF</span> <span class="cm-keyword">or</span> <span class="cm-variable">k</span> &gt;= <span class="cm-number">0x1B00</span> <span class="cm-keyword">and</span> <span class="cm-variable">k</span> &lt;= <span class="cm-number">0x1B7F</span> <span class="cm-keyword">or</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">k</span> &gt;= <span class="cm-number">0x2200</span> <span class="cm-keyword">and</span> <span class="cm-variable">k</span> &lt;= <span class="cm-number">0x22FF</span> <span class="cm-keyword">or</span> <span class="cm-variable">k</span> &gt;= <span class="cm-number">0x2190</span> <span class="cm-keyword">and</span> <span class="cm-variable">k</span> &lt;= <span class="cm-number">0x21FF</span> <span class="cm-keyword">or</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">k</span> &gt;= <span class="cm-number">0x2A00</span> <span class="cm-keyword">and</span> <span class="cm-variable">k</span> &lt;= <span class="cm-number">0x2AFF</span> <span class="cm-keyword">or</span> <span class="cm-variable">k</span> &gt;= <span class="cm-number">0x11100</span> <span class="cm-keyword">and</span> <span class="cm-variable">k</span> &lt;= <span class="cm-number">0x1137F</span> <span class="cm-keyword">or</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">k</span> &gt;= <span class="cm-number">0x1D100</span> <span class="cm-keyword">and</span> <span class="cm-variable">k</span> &lt;= <span class="cm-number">0x1D1FF</span> <span class="cm-keyword">then</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">flag</span> = <span class="cm-keyword">false</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">norm</span> = <span class="cm-variable">homo_pairs</span>[<span class="cm-variable">b</span>] <span class="cm-keyword">or</span> <span class="cm-variable">b</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">flag</span> <span class="cm-keyword">then</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">norm</span>:<span class="cm-variable">match</span>(<span class="cm-string">'^[A-Z]$'</span>) <span class="cm-keyword">or</span> <span class="cm-keyword">not</span> <span class="cm-variable">homo_pairs</span>[<span class="cm-variable">a</span>] <span class="cm-keyword">then</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">homo_pairs</span>[<span class="cm-variable">a</span>] = <span class="cm-variable">norm</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">end</span></span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">end</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 414px;"></div><div class="CodeMirror-gutters" style="display: none; height: 414px;"></div></div></div></pre><p><span>这其中有一个工具函数是用的我自己的实现，就是utf8char，把Unicode转成UTF-8编码。应该是在全网都没有相同的实现。因为常见的实现都会限制在4个字节内（即最高编码到</span><code>U+1FFFFF</code><span>），我这个实现是自己瞎搞的，所以不必在意4个字节的限制，超出4个字节就会继续，可以编到</span><code>U+7FFFFFFF</code><span>都没有问题。虽然</span><a href='https://tools.ietf.org/html/rfc3629#page-11'><span>RFC 3629</span></a><span>限制了UTF-8只能编码到</span><code>U+10FFFF</code><span>，但不要让RFC限制我们的想象嘛，哈哈。</span></p><pre lang="lua" class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="lua"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre>x</pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span class="cm-keyword">function</span> <span class="cm-variable">utf8char</span>(<span class="cm-variable">unicode</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">char</span> = <span class="cm-builtin">string.char</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">unicode</span> &lt;= <span class="cm-number">0x7F</span> <span class="cm-keyword">then</span> <span class="cm-keyword">return</span> <span class="cm-variable">char</span>(<span class="cm-variable">unicode</span>) <span class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">continue_flag</span> = <span class="cm-variable">bit.rshift</span>(<span class="cm-variable">unicode</span>, <span class="cm-number">6</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">bytes</span> = {}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">fill</span> = <span class="cm-number">0xFF80</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">repeat</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">bytes</span>[#<span class="cm-variable">bytes</span> + <span class="cm-number">1</span>] = <span class="cm-number">0x80</span> + <span class="cm-variable">bit.band</span>(<span class="cm-variable">unicode</span>, <span class="cm-number">0x3F</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">unicode</span> = <span class="cm-variable">bit.rshift</span>(<span class="cm-variable">unicode</span>, <span class="cm-number">6</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">continue_flag</span> = <span class="cm-variable">bit.rshift</span>(<span class="cm-variable">continue_flag</span>, <span class="cm-number">5</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">fill</span> = <span class="cm-variable">bit.rshift</span>(<span class="cm-variable">fill</span>, <span class="cm-number">1</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">until</span> <span class="cm-variable">continue_flag</span> == <span class="cm-number">0</span></span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">bytes</span>[#<span class="cm-variable">bytes</span> + <span class="cm-number">1</span>] = <span class="cm-variable">bit.band</span>(<span class="cm-variable">fill</span>, <span class="cm-number">0xFF</span>) + <span class="cm-variable">unicode</span>;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">char</span>(<span class="cm-builtin">unpack</span>(<span class="cm-variable">table.reverse</span>(<span class="cm-variable">bytes</span>)))</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">end</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 437px;"></div><div class="CodeMirror-gutters" style="display: none; height: 437px;"></div></div></div></pre><p><span>在这些数据的加持下，我的eccnorm就终于完成了，代码也上传到了</span><a href='https://github.com/AlexanderMisel/ccnorm' target='_blank' class='url'>https://github.com/AlexanderMisel/ccnorm</a><span> 。</span></p><h2><a name="实际运用时的小改进" class="md-header-anchor"></a><span>实际运用时的小改进</span></h2><p><span>在实际使用中，遇到群友使用</span><strong><span>附加符号</span></strong><span>（diacritics）捣乱的情形。的确，对于标准的Unicode归一化我们游刃有余了，但是加上了diacritics的文字又变得难以匹配了。但还好diacritics在Unicode的范围非常集中，所以我就稍稍排除了一下，大家可以参考这段代码</span></p><pre lang="lua" class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="lua"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre>x</pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">teststr</span> = <span class="cm-variable">teststr</span>:<span class="cm-variable">gsub</span>(<span class="cm-string">'[%z\1-\127\194-\244][\128-\191]*'</span>, <span class="cm-keyword">function</span>(<span class="cm-variable">p</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">unicode</span> = <span class="cm-variable">utf8to32</span>(<span class="cm-variable">p</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">unicode</span> &gt;= <span class="cm-number">0x0300</span> <span class="cm-keyword">and</span> <span class="cm-variable">unicode</span> &lt;= <span class="cm-number">0x036F</span> <span class="cm-keyword">or</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">unicode</span> &gt;= <span class="cm-number">0x1DC0</span> <span class="cm-keyword">and</span> <span class="cm-variable">unicode</span> &lt;= <span class="cm-number">0x1DFF</span> <span class="cm-keyword">or</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">unicode</span> &gt;= <span class="cm-number">0x20D0</span> <span class="cm-keyword">and</span> <span class="cm-variable">unicode</span> &lt;= <span class="cm-number">0x20FF</span> <span class="cm-keyword">or</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">unicode</span> &gt;= <span class="cm-number">0xFE20</span> <span class="cm-keyword">and</span> <span class="cm-variable">unicode</span> &lt;= <span class="cm-number">0xFE2F</span> <span class="cm-keyword">then</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-string">''</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">equivset</span>[<span class="cm-variable">p</span>] <span class="cm-keyword">or</span> <span class="cm-variable">p</span></span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">end</span>)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 230px;"></div><div class="CodeMirror-gutters" style="display: none; height: 230px;"></div></div></div></pre><p><span>这样c̳̻͚̻̩̻͉̯̄̏͑̋͆̎͐ͬ͑͌́͢h̵͔͈͍͇̪̯͇̞͖͇̜͉̪̪̤̙ͧͣ̓̐̓ͤ͋͒ͥ͑̆͒̓͋̑́͞ǎ̡̮̤̤̬͚̝͙̞͎̇ͧ͆͊ͅo̴̲̺͓̖͖͉̜̟̗̮̳͉̻͉̫̯̫̍̋̿̒͌̃̂͊̏̈̏̿ͧ́ͬ̌ͥ̇̓̀͢͜s̵̵̘̹̜̝̘̺̙̻̠̱͚̤͓͚̠͙̝͕͆̿̽ͥ̃͠͡也可以就可以了直接转换为CHAOS了，一步到位。这就是有关构建Unicode归一化数据的内容。</span><a href='../' title='返回首页'><span>∎</span></a></p><p>&nbsp;</p><div class='footnotes-area'  ><hr/>
<div class='footnote-line'><span class='md-fn-count'>1</span> <span>这是我自己的描述。其实准确定义NFD是不好定义的。这里“基础部分”与汉字拆解意义不同。它强调的是把附加符拆掉（比如把</span><strong><span>ü</span></strong><span>拆成</span><strong><span>u</span></strong><span>和</span><strong><span>¨</span></strong><span>），以及把合字拆开（比如把德语字母</span><strong><span>ß</span></strong><span>拆成</span><strong><span>ss</span></strong><span>）。而拆解汉字实际类似于转换成</span><strong><span>IDS</span></strong><span>（表意描述序列）。所以二者是不同的。</span> <a name='dfref-footnote-1' href='#ref-footnote-1' title='回到文档' class='reversefootnote' >↩</a></div></div></div>
<script src="../dist/style_fix.js"></script>
<script src="../dist/mini_pangu.js"></script>
</body>
</html>